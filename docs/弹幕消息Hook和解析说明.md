# å¼¹å¹•æ¶ˆæ¯ Hook å’Œè§£æè¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç³»ç»Ÿå·²ç»å®ç°äº†å®Œæ•´çš„æŠ–éŸ³ç›´æ’­å¼¹å¹• Hook å’Œè§£æåŠŸèƒ½ï¼š

1. âœ… **WebSocket æ‹¦æˆª** - æ‹¦æˆªç›´æ’­é—´çš„ WebSocket è¿æ¥
2. âœ… **äºŒè¿›åˆ¶æ¶ˆæ¯æ•è·** - æ•è· Protobuf æ ¼å¼çš„å¼¹å¹•æ•°æ®
3. âœ… **Protobuf è§£æ** - ä½¿ç”¨ dycast æ¨¡å‹è§£ææ¶ˆæ¯
4. âœ… **æ¶ˆæ¯ç±»å‹è¯†åˆ«** - æ”¯æŒèŠå¤©ã€ç¤¼ç‰©ã€ç‚¹èµã€è¿›å…¥ã€å…³æ³¨ç­‰
5. âœ… **è¯¦ç»†æ§åˆ¶å°è¾“å‡º** - åœ¨ Electron ä¸»è¿›ç¨‹æ§åˆ¶å°è¾“å‡ºè¯¦ç»†ä¿¡æ¯

## ğŸ” å¦‚ä½•æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º

### å¼€å‘ç¯å¢ƒ

åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œæœ‰ä¸¤ä¸ªæ§åˆ¶å°çª—å£ï¼š

#### 1. **ä¸»è¿›ç¨‹æ§åˆ¶å°**ï¼ˆç»ˆç«¯/å‘½ä»¤è¡Œï¼‰
è¿™é‡Œä¼šæ˜¾ç¤º**æ‰€æœ‰å¼¹å¹•æ¶ˆæ¯**çš„è¯¦ç»†ä¿¡æ¯ï¼š

```bash
npm run dev
# æˆ–
yarn dev
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸ“¦ [Protobuf] æ”¶åˆ°æ¶ˆæ¯: payloadType=msg, logId=20241127...
   ğŸ“‹ æ¶ˆæ¯æ•°é‡: 3
   â”œâ”€ æ¶ˆæ¯ 1/3: WebcastChatMessage
   â”‚  âœ“ [ç”¨æˆ·æ˜µç§°] ä½ å¥½å•Šä¸»æ’­
   â”œâ”€ æ¶ˆæ¯ 2/3: WebcastGiftMessage
   â”‚  âœ“ [åœŸè±ªç”¨æˆ·] ç«ç‘°
   â”œâ”€ æ¶ˆæ¯ 3/3: WebcastMemberMessage
   â”‚  âœ“ [æ–°è§‚ä¼—] è¿›å…¥ç›´æ’­é—´
   âœ… è§£æå®Œæˆï¼š3 æ¡æœ‰æ•ˆå¼¹å¹•

ğŸ’¬ [12:34:56] èŠå¤©æ¶ˆæ¯
   ğŸ‘¤ ç”¨æˆ·æ˜µç§° (Lv.15)
   å†…å®¹: ä½ å¥½å•Šä¸»æ’­
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ [12:34:57] ç¤¼ç‰©æ¶ˆæ¯
   ğŸ‘¤ åœŸè±ªç”¨æˆ· (Lv.42)
   ç¤¼ç‰©: ç«ç‘° x1
   ä»·å€¼: 1 æŠ–å¸
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ [12:34:58] è¿›å…¥ç›´æ’­é—´
   ğŸ‘¤ æ–°è§‚ä¼— (Lv.8)
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

#### 2. **æ¸²æŸ“è¿›ç¨‹æ§åˆ¶å°**ï¼ˆæµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼‰
è¿™é‡Œä¼šæ˜¾ç¤ºå‰ç«¯çš„è°ƒè¯•ä¿¡æ¯å’Œæ”¶åˆ°çš„å¼¹å¹•äº‹ä»¶ã€‚

åœ¨ä¸»çª—å£æŒ‰ `F12` æˆ– `Ctrl+Shift+I` æ‰“å¼€å¼€å‘è€…å·¥å…·ã€‚

### ç”Ÿäº§ç¯å¢ƒ

æ‰“åŒ…åçš„åº”ç”¨ä¹Ÿå¯ä»¥æŸ¥çœ‹æ—¥å¿—ï¼š

#### Windows
```powershell
# åº”ç”¨ç›®å½•ä¸‹è¿è¡Œ
.\your-app.exe > log.txt 2>&1
```

#### macOS/Linux
```bash
./your-app > log.txt 2>&1
```

## ğŸ“Š æ§åˆ¶å°è¾“å‡ºå±‚çº§

### Level 1: WebSocket å±‚

```
ğŸ”— WebSocket å·²è¿æ¥: wss://...
ğŸ“Š WebSocket ç»Ÿè®¡: å·²æ¥æ”¶ 1 æ¡äºŒè¿›åˆ¶æ¶ˆæ¯
ğŸ“Š WebSocket ç»Ÿè®¡: å·²æ¥æ”¶ 11 æ¡äºŒè¿›åˆ¶æ¶ˆæ¯
ğŸ“Š WebSocket ç»Ÿè®¡: å·²æ¥æ”¶ 21 æ¡äºŒè¿›åˆ¶æ¶ˆæ¯
```

### Level 2: Protobuf è§£æå±‚

```
ğŸ“¦ [Protobuf] æ”¶åˆ°æ¶ˆæ¯: payloadType=msg, logId=...
   ğŸ—œï¸  æ£€æµ‹åˆ° gzip å‹ç¼©ï¼Œè§£å‹ä¸­...
   âœ… è§£å‹æˆåŠŸ: 1234 bytes
   ğŸ“‹ æ¶ˆæ¯æ•°é‡: 2
   â”œâ”€ æ¶ˆæ¯ 1/2: WebcastChatMessage
   â”‚  âœ“ [æ˜µç§°] å†…å®¹
   â”œâ”€ æ¶ˆæ¯ 2/2: WebcastGiftMessage
   â”‚  âœ“ [æ˜µç§°] ç¤¼ç‰©å
   âœ… è§£æå®Œæˆï¼š2 æ¡æœ‰æ•ˆå¼¹å¹•
```

### Level 3: å¼¹å¹•å±•ç¤ºå±‚

```
ğŸ’¬ [12:34:56] èŠå¤©æ¶ˆæ¯
   ğŸ‘¤ ç”¨æˆ·æ˜µç§° (Lv.15)
   å†…å®¹: æ¶ˆæ¯å†…å®¹
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ [12:34:57] ç¤¼ç‰©æ¶ˆæ¯
   ğŸ‘¤ é€ç¤¼è€… (Lv.42)
   ç¤¼ç‰©: ç¤¼ç‰©åç§° xæ•°é‡
   ä»·å€¼: XX æŠ–å¸
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

## ğŸ¯ æ”¯æŒçš„æ¶ˆæ¯ç±»å‹

| å›¾æ ‡ | ç±»å‹ | Protobuf æ–¹æ³• | è¯´æ˜ |
|------|------|---------------|------|
| ğŸ’¬ | èŠå¤©æ¶ˆæ¯ | WebcastChatMessage | æ™®é€šæ–‡å­—å¼¹å¹• |
| ğŸ | ç¤¼ç‰©æ¶ˆæ¯ | WebcastGiftMessage | ç”¨æˆ·é€ç¤¼ç‰© |
| ğŸ‘ | ç‚¹èµ | WebcastLikeMessage | ç”¨æˆ·ç‚¹èµ |
| âœ¨ | è¿›å…¥ç›´æ’­é—´ | WebcastMemberMessage | ç”¨æˆ·è¿›å…¥ |
| â¤ï¸ | å…³æ³¨ä¸»æ’­ | WebcastSocialMessage | ç”¨æˆ·å…³æ³¨ |
| ğŸ˜Š | è¡¨æƒ…æ¶ˆæ¯ | WebcastEmojiChatMessage | å‘é€è¡¨æƒ… |

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹åŸå§‹ WebSocket æµé‡

åœ¨ç›´æ’­é—´çª—å£æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼š
- Windows: `Ctrl + Shift + I`
- macOS: `Cmd + Option + I`

ç„¶åæŸ¥çœ‹ Network -> WS (WebSocket) æ ‡ç­¾ã€‚

### 2. å¢åŠ /å‡å°‘æ—¥å¿—è¯¦ç»†ç¨‹åº¦

ç¼–è¾‘ `electron/douyin/live-monitor.ts`ï¼š

```typescript
// å‡å°‘æ—¥å¿—ï¼ˆæ³¨é‡Šæ‰ä¸éœ€è¦çš„ console.logï¼‰
// console.log(`ğŸ“¦ [Protobuf] æ”¶åˆ°æ¶ˆæ¯...`)

// å¢åŠ æ—¥å¿—ï¼ˆæ·»åŠ æ›´å¤šè°ƒè¯•ä¿¡æ¯ï¼‰
console.log('åŸå§‹æ•°æ®:', JSON.stringify(msg, null, 2))
```

### 3. è¿‡æ»¤ç‰¹å®šæ¶ˆæ¯ç±»å‹

åœ¨ `protobuf-parser-dycast.ts` ä¸­ï¼š

```typescript
// åªæ˜¾ç¤ºèŠå¤©æ¶ˆæ¯
if (parsedMsg.type === 'chat') {
    console.log(`ğŸ’¬ [${parsedMsg.nickname}]: ${parsedMsg.content}`)
}
```

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ§åˆ¶å°æ²¡æœ‰å¼¹å¹•è¾“å‡ºï¼Ÿ

**æ£€æŸ¥æ¸…å•ï¼š**
1. âœ… ç¡®è®¤å·²ç™»å½•æŠ–éŸ³è´¦å·
2. âœ… ç¡®è®¤ç›´æ’­é—´çª—å£å·²æ‰“å¼€
3. âœ… ç¡®è®¤ç›´æ’­é—´æœ‰è§‚ä¼—åœ¨å‘å¼¹å¹•
4. âœ… æŸ¥çœ‹æ˜¯å¦æœ‰ WebSocket è¿æ¥æˆåŠŸçš„æ—¥å¿—
5. âœ… æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

### Q2: åªæœ‰å¿ƒè·³åŒ…ï¼Œæ²¡æœ‰å¼¹å¹•ï¼Ÿ

å¿ƒè·³åŒ…ï¼ˆpayloadType=hbï¼‰ä¸åŒ…å«å¼¹å¹•æ•°æ®ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚åªæœ‰ `payloadType=msg` çš„æ¶ˆæ¯æ‰åŒ…å«å¼¹å¹•ã€‚

```
ğŸ“¦ [Protobuf] æ”¶åˆ°æ¶ˆæ¯: payloadType=hb, logId=...  â† å¿ƒè·³åŒ…ï¼ˆæ­£å¸¸ï¼‰
ğŸ“¦ [Protobuf] æ”¶åˆ°æ¶ˆæ¯: payloadType=msg, logId=... â† å¼¹å¹•æ•°æ®ï¼ˆéœ€è¦çš„ï¼‰
```

### Q3: å¼¹å¹•è§£æå¤±è´¥ï¼Ÿ

å¯èƒ½çš„åŸå› ï¼š
1. Protobuf ç»“æ„å‘ç”Ÿå˜åŒ–ï¼ˆæŠ–éŸ³æ›´æ–°äº†åè®®ï¼‰
2. gzip è§£å‹å¤±è´¥
3. æ¶ˆæ¯æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ

**è§£å†³æ–¹æ³•ï¼š**
æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—ï¼Œå¿…è¦æ—¶æ›´æ–° `dycast-model.ts` ä¸­çš„ Protobuf å®šä¹‰ã€‚

### Q4: æ§åˆ¶å°è¾“å‡ºå¤ªå¤šï¼Ÿ

å¯ä»¥è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼š

```typescript
// åœ¨ protobuf-parser-dycast.ts ä¸­
// æ³¨é‡Šæ‰è¯¦ç»†æ—¥å¿—
// console.log(`   â”œâ”€ æ¶ˆæ¯ ${i + 1}/${response.messages.length}: ${method}`)
```

æˆ–è€…åªè¾“å‡ºå…³é”®ä¿¡æ¯ï¼š

```typescript
// åªè¾“å‡ºè§£æåçš„å¼¹å¹•ï¼Œä¸è¾“å‡ºä¸­é—´è¿‡ç¨‹
if (parsedMsg) {
    results.push(parsedMsg)
    // console.log(...) // æ³¨é‡Šæ‰
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å‡å°‘æ—¥å¿—è¾“å‡º

é¢‘ç¹çš„ console.log ä¼šå½±å“æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¼¹å¹•é‡å¤§çš„ç›´æ’­é—´ã€‚

**å»ºè®®ï¼š**
- å¼€å‘è°ƒè¯•æ—¶ï¼šä¿æŒè¯¦ç»†æ—¥å¿—
- ç”Ÿäº§ç¯å¢ƒï¼šåªä¿ç•™å…³é”®é”™è¯¯æ—¥å¿—

### 2. æ¶ˆæ¯æ‰¹å¤„ç†

å½“å‰æ¯æ¡å¼¹å¹•éƒ½å•ç‹¬è¾“å‡ºï¼Œå¯ä»¥è€ƒè™‘æ‰¹é‡è¾“å‡ºï¼š

```typescript
// æ”¶é›† 1 ç§’å†…çš„å¼¹å¹•ï¼Œä¸€æ¬¡æ€§è¾“å‡º
let batchMessages = []
setInterval(() => {
    if (batchMessages.length > 0) {
        console.log(`ğŸ“¦ æ‰¹é‡æ¶ˆæ¯ (${batchMessages.length} æ¡):`)
        batchMessages.forEach(msg => console.log(`  - ${msg}`))
        batchMessages = []
    }
}, 1000)
```

## ğŸ“ æ‰©å±•é˜…è¯»

- [dycast é¡¹ç›®](https://github.com/hua0512/douyin-live-recorder) - Protobuf å®šä¹‰æ¥æº
- [Electron IPC æ–‡æ¡£](https://www.electronjs.org/docs/latest/api/ipc-main)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
- [Protocol Buffers](https://developers.google.com/protocol-buffers)

## ğŸ’¡ ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»å¯ä»¥çœ‹åˆ°æ‰€æœ‰å¼¹å¹•æ¶ˆæ¯ï¼Œå¯ä»¥ï¼š

1. **å­˜å‚¨å¼¹å¹•** - å°†å¼¹å¹•ä¿å­˜åˆ°æ•°æ®åº“
2. **è¿‡æ»¤å¼¹å¹•** - å®ç°å…³é”®è¯è¿‡æ»¤
3. **ç»Ÿè®¡åˆ†æ** - åˆ†æå¼¹å¹•çƒ­è¯ã€æ´»è·ƒç”¨æˆ·ç­‰
4. **è‡ªåŠ¨å›å¤** - æ ¹æ®å¼¹å¹•å†…å®¹è‡ªåŠ¨å›å¤ï¼ˆéœ€è¦å‘é€æƒé™ï¼‰
5. **æ‰“å°å¼¹å¹•** - å°†å¼¹å¹•å‘é€åˆ°æ‰“å°æœº


