# æŠ–éŸ³ç™»å½•æŠ€æœ¯å®ç°è¯¦è§£

## ğŸ¯ æ ¸å¿ƒæ€è·¯

ä½¿ç”¨ Electron çš„ **BrowserView** åˆ›å»ºä¸€ä¸ªå†…åµŒæµè§ˆå™¨ï¼Œè®©ç”¨æˆ·åœ¨çœŸå®çš„æŠ–éŸ³ç½‘ç«™ä¸Šç™»å½•ï¼Œç„¶åé€šè¿‡ç›‘å¬é¡µé¢å¯¼èˆªå’Œæå– Cookie æ¥åˆ¤æ–­ç™»å½•çŠ¶æ€ã€‚

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»"ç™»å½•æŠ–éŸ³"
    â†“
åˆ›å»º BrowserView çª—å£
    â†“
åŠ è½½ https://www.douyin.com/
    â†“
ç”¨æˆ·åœ¨çœŸå®æŠ–éŸ³é¡µé¢ç™»å½•
    â”œâ”€ æ‰«ç ç™»å½•
    â”œâ”€ å¯†ç ç™»å½•
    â””â”€ æ‰‹æœºéªŒè¯ç ç™»å½•
    â†“
ç›‘å¬ URL å˜åŒ–
    â”œâ”€ did-navigate (å®Œæ•´é¡µé¢å¯¼èˆª)
    â””â”€ did-navigate-in-page (å•é¡µåº”ç”¨å†…å¯¼èˆª)
    â†“
æ£€æµ‹ URL æ˜¯å¦ç¬¦åˆ"ç™»å½•æˆåŠŸ"ç‰¹å¾
    â”œâ”€ âœ… åŒ…å« douyin.com
    â”œâ”€ âŒ ä¸åŒ…å« login
    â””â”€ âŒ ä¸åŒ…å« passport
    â†“
æå– Cookie
    â””â”€ session.cookies.get()
    â†“
æå–ç”¨æˆ·ä¿¡æ¯
    â”œâ”€ æ–¹æ³•1: window.__INITIAL_STATE__
    â”œâ”€ æ–¹æ³•2: localStorage
    â”œâ”€ æ–¹æ³•3: DOM å…ƒç´ 
    â””â”€ æ–¹æ³•4: Cookie ä¸­çš„ uid
    â†“
ä¿å­˜è´¦å·ä¿¡æ¯
    â”œâ”€ AES-256-CBC åŠ å¯† Cookie
    â”œâ”€ ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
    â””â”€ ä¿å­˜åˆ° Electron Session
    â†“
å…³é—­ç™»å½•çª—å£
    â†“
âœ… ç™»å½•å®Œæˆ
```

## ğŸ” å…³é”®æŠ€æœ¯ç‚¹è¯¦è§£

### 1. BrowserView vs BrowserWindow

**ä¸ºä»€ä¹ˆç”¨ BrowserViewï¼Ÿ**

```typescript
// BrowserView çš„ä¼˜åŠ¿ï¼š
// 1. å¯ä»¥åµŒå…¥åˆ°ä¸»çª—å£ä¸­
// 2. å®Œæ•´çš„æµè§ˆå™¨ç¯å¢ƒï¼ˆæ”¯æŒæŠ–éŸ³çš„æ‰€æœ‰ç™»å½•æ–¹å¼ï¼‰
// 3. ç‹¬ç«‹çš„ Sessionï¼ˆCookie éš”ç¦»ï¼‰
// 4. å¯ä»¥å®Œå…¨æ§åˆ¶æ˜¾ç¤ºåŒºåŸŸ

this.browserView = new BrowserView({
  webPreferences: {
    partition: 'persist:douyin',  // ğŸ”´ å…³é”®ï¼šç‹¬ç«‹çš„ Session
    contextIsolation: true,        // å®‰å…¨éš”ç¦»
    nodeIntegration: false,        // ä¸æš´éœ² Node.js API
    webSecurity: true,             // å¯ç”¨ Web å®‰å…¨ç­–ç•¥
  }
});
```

### 2. å¦‚ä½•æ£€æµ‹ç™»å½•æˆåŠŸï¼Ÿ

#### æ–¹æ³•ä¸€ï¼šURL å˜åŒ–æ£€æµ‹ â­æ¨è

```typescript
// ç›‘å¬é¡µé¢å¯¼èˆªäº‹ä»¶
this.browserView.webContents.on('did-navigate', async (_event, url) => {
  await this.checkLoginSuccess(url);
});

// æ£€æŸ¥é€»è¾‘
private async checkLoginSuccess(url: string): Promise<void> {
  // ç™»å½•æˆåŠŸçš„ç‰¹å¾ï¼š
  // 1. åœ¨æŠ–éŸ³åŸŸåä¸‹
  // 2. ä¸åœ¨ç™»å½•é¡µé¢ï¼ˆ/login, /passportï¼‰
  // 3. é€šå¸¸ä¼šè·³è½¬åˆ°é¦–é¡µæˆ–ä¸ªäººä¸»é¡µ
  
  const isDouyinHomePage = 
    url.includes('douyin.com') &&
    !url.includes('login') &&
    !url.includes('passport');
    
  if (isDouyinHomePage) {
    // å¯èƒ½ç™»å½•æˆåŠŸäº†ï¼
  }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·å¯ä»¥ï¼Ÿ**

æŠ–éŸ³ç™»å½•æµç¨‹ï¼š
```
https://www.douyin.com/                          (æœªç™»å½•ï¼Œä¼šé‡å®šå‘)
    â†“
https://www.douyin.com/passport/web/login/      (ç™»å½•é¡µé¢)
    â†“ (ç”¨æˆ·ç™»å½•)
https://www.douyin.com/                          (é¦–é¡µï¼Œå·²ç™»å½•) âœ…
æˆ–
https://www.douyin.com/user/MS4wLjABAAAA...     (ä¸ªäººä¸»é¡µ) âœ…
```

#### æ–¹æ³•äºŒï¼šCookie æ£€æµ‹

```typescript
// è·å– Session ä¸­çš„æ‰€æœ‰ Cookie
const cookies = await session
  .fromPartition('persist:douyin')
  .cookies.get({ domain: '.douyin.com' });

// æ£€æŸ¥å…³é”® Cookie æ˜¯å¦å­˜åœ¨
const keyCookies = [
  'sessionid',      // æœ€é‡è¦çš„ä¼šè¯ ID
  'sessionid_ss',   // å®‰å…¨ä¼šè¯ ID
  'sid_guard',      // ä¼šè¯å®ˆå«
  'uid_tt',         // ç”¨æˆ· ID
  'ttwid'          // è®¾å¤‡ ID
];

const hasValidCookie = keyCookies.some(name => 
  cookies.find(c => c.name === name)
);

if (hasValidCookie) {
  // æœ‰å…³é”® Cookieï¼Œå¯èƒ½å·²ç™»å½• âœ…
}
```

### 3. å¦‚ä½•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Ÿ

#### æ–¹æ³•ä¸€ï¼šä»é¡µé¢çš„å…¨å±€å˜é‡è·å– â­â­â­â­â­

```typescript
const result = await this.browserView.webContents.executeJavaScript(`
  (function() {
    // æŠ–éŸ³çš„é¡µé¢é€šå¸¸ä¼šåœ¨å…¨å±€å˜é‡ä¸­å­˜å‚¨åˆå§‹çŠ¶æ€
    if (window.__INITIAL_STATE__ && window.__INITIAL_STATE__.user) {
      const user = window.__INITIAL_STATE__.user.userInfo;
      return {
        nickname: user.nickname,
        uid: user.uid,
        avatarUrl: user.avatar_thumb?.url_list?.[0]
      };
    }
    return null;
  })();
`);
```

**ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼Ÿ**

ç°ä»£ SPAï¼ˆå•é¡µåº”ç”¨ï¼‰é€šå¸¸ä¼šåœ¨é¡µé¢åŠ è½½æ—¶æ³¨å…¥åˆå§‹çŠ¶æ€åˆ°å…¨å±€å˜é‡ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯ JavaScript ä½¿ç”¨ã€‚

#### æ–¹æ³•äºŒï¼šä» localStorage è·å– â­â­â­â­

```typescript
const userInfoStr = localStorage.getItem('userInfo');
if (userInfoStr) {
  const userInfo = JSON.parse(userInfoStr);
  return {
    nickname: userInfo.nickname,
    uid: userInfo.uid
  };
}
```

#### æ–¹æ³•ä¸‰ï¼šä» DOM å…ƒç´ æå– â­â­â­

```typescript
const nicknameEl = document.querySelector('.user-info .nickname');
if (nicknameEl) {
  return {
    nickname: nicknameEl.textContent.trim()
  };
}
```

#### æ–¹æ³•å››ï¼šä» Cookie æå– â­â­

```typescript
// Cookie ä¸­é€šå¸¸åŒ…å«ç”¨æˆ· ID
const uidCookie = cookies.find(c => c.name === 'uid_tt');
if (uidCookie) {
  return {
    nickname: `æŠ–éŸ³ç”¨æˆ·_${uidCookie.value.slice(-6)}`,
    uid: uidCookie.value
  };
}
```

### 4. Cookie çš„è·å–ä¸ä¿å­˜

#### 4.1 è·å– Cookie

```typescript
// electron/douyin/cookie-manager.ts

async getCookiesFromSession(partition: string): Promise<DouyinCookie[]> {
  const douyinSession = session.fromPartition(partition);
  
  // è·å–æ‰€æœ‰æŠ–éŸ³ç›¸å…³çš„ Cookie
  const allCookies = await douyinSession.cookies.get({
    domain: '.douyin.com'
  });
  
  // å…³é”® Cookie åˆ—è¡¨
  const DOUYIN_COOKIES = [
    'sessionid',
    'sessionid_ss',
    'sid_guard',
    'uid_tt',
    'uid_tt_ss',
    'sid_tt',
    'ttwid',
    'odin_tt',
    '__ac_nonce',
    'passport_csrf_token'
  ];
  
  // è¿‡æ»¤å‡ºå…³é”® Cookie
  const keyCookies = allCookies.filter(cookie =>
    DOUYIN_COOKIES.includes(cookie.name)
  );
  
  return keyCookies;
}
```

#### 4.2 Cookie åŠ å¯†å­˜å‚¨

```typescript
// ä½¿ç”¨ AES-256-CBC åŠ å¯†
private encrypt(data: string): string {
  const key = scryptSync('your-secret-key', SALT, KEY_LENGTH);
  const iv = randomBytes(IV_LENGTH);
  const cipher = createCipheriv(ALGORITHM, key, iv);
  
  let encrypted = cipher.update(data, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  // IV + åŠ å¯†æ•°æ®
  return iv.toString('hex') + ':' + encrypted;
}

// ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
async saveAccount(account: DouyinAccount): Promise<boolean> {
  const data = JSON.stringify(account);
  const encrypted = this.encrypt(data);
  
  // ä¿å­˜åˆ° userData ç›®å½•
  writeFileSync(COOKIE_FILE, encrypted, 'utf8');
  
  return true;
}
```

**ä¸ºä»€ä¹ˆè¦åŠ å¯†ï¼Ÿ**

1. **å®‰å…¨æ€§**ï¼šCookie åŒ…å«ä¼šè¯ä¿¡æ¯ï¼Œæ˜æ–‡å­˜å‚¨ä¼šæœ‰å®‰å…¨é£é™©
2. **é˜²ç¯¡æ”¹**ï¼šåŠ å¯†åçš„æ•°æ®æ›´éš¾è¢«æ¶æ„ä¿®æ”¹
3. **åˆè§„æ€§**ï¼šç¬¦åˆæ•°æ®ä¿æŠ¤çš„æœ€ä½³å®è·µ

#### 4.3 Cookie ç»“æ„

```typescript
interface DouyinCookie {
  name: string;          // Cookie åç§°
  value: string;         // Cookie å€¼
  domain: string;        // åŸŸåï¼ˆå¦‚ .douyin.comï¼‰
  path: string;          // è·¯å¾„ï¼ˆé€šå¸¸æ˜¯ /ï¼‰
  secure: boolean;       // æ˜¯å¦ä»… HTTPS
  httpOnly: boolean;     // æ˜¯å¦ä»… HTTPï¼ˆä¸å¯è¢« JS è®¿é—®ï¼‰
  expirationDate: number;// è¿‡æœŸæ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰
  sameSite: string;      // SameSite ç­–ç•¥
}

interface DouyinAccount {
  nickname: string;        // æ˜µç§°
  uid: string;            // ç”¨æˆ· ID
  avatarUrl?: string;     // å¤´åƒ URL
  cookies: DouyinCookie[];// Cookie æ•°ç»„
  loginTime: number;      // ç™»å½•æ—¶é—´
  lastActiveTime: number; // æœ€åæ´»è·ƒæ—¶é—´
}
```

### 5. Session Partitionï¼ˆä¼šè¯éš”ç¦»ï¼‰

```typescript
// ä¸ºä»€ä¹ˆä½¿ç”¨ 'persist:douyin'ï¼Ÿ

// 1. persist: è¡¨ç¤ºæŒä¹…åŒ–ï¼ˆä¿å­˜åˆ°ç£ç›˜ï¼‰
// 2. douyin: å‘½åç©ºé—´ï¼ˆä¸å…¶ä»–åŠŸèƒ½éš”ç¦»ï¼‰

const partition = 'persist:douyin';

// æ•ˆæœï¼š
// - Cookie ä¼šè¢«æŒä¹…åŒ–ä¿å­˜
// - åº”ç”¨é‡å¯å Cookie ä»ç„¶å­˜åœ¨
// - ä¸é»˜è®¤ Session éš”ç¦»ï¼ˆä¸ä¼šå½±å“å…¶ä»–åŠŸèƒ½ï¼‰
// - å¯ä»¥åœ¨å¤šä¸ª BrowserView é—´å…±äº«ï¼ˆåªè¦ä½¿ç”¨ç›¸åŒçš„ partitionï¼‰

// ç™»å½•çª—å£ä½¿ç”¨
new BrowserView({
  webPreferences: {
    partition: 'persist:douyin'  // âœ… å…±äº« Session
  }
});

// ç›´æ’­ç›‘æ§çª—å£ä¹Ÿä½¿ç”¨
new BrowserView({
  webPreferences: {
    partition: 'persist:douyin'  // âœ… å…±äº«åŒä¸€ä¸ª Session
  }
});

// ç»“æœï¼šç™»å½•ä¸€æ¬¡ï¼Œæ‰€æœ‰åœ°æ–¹éƒ½èƒ½ç”¨ï¼
```

## ğŸ” å®‰å…¨æœºåˆ¶

### 1. Context Isolationï¼ˆä¸Šä¸‹æ–‡éš”ç¦»ï¼‰

```typescript
webPreferences: {
  contextIsolation: true,   // âœ… éš”ç¦»æ¸²æŸ“è¿›ç¨‹å’Œé¢„åŠ è½½è„šæœ¬
  nodeIntegration: false,   // âœ… ä¸æš´éœ² Node.js API
  webSecurity: true         // âœ… å¯ç”¨åŒæºç­–ç•¥
}
```

**ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ**

- é˜²æ­¢æ¶æ„ç½‘ç«™è®¿é—® Electron/Node.js API
- é˜²æ­¢ XSS æ”»å‡»
- ä¿æŠ¤ç”¨æˆ·éšç§å’Œç³»ç»Ÿå®‰å…¨

### 2. Cookie åŠ å¯†

ä½¿ç”¨ **AES-256-CBC** åŠ å¯†ç®—æ³•ï¼š

- **å¯†é’¥æ´¾ç”Ÿ**ï¼šä½¿ç”¨ scrypt ä»å¯†ç æ´¾ç”Ÿå¯†é’¥
- **åˆå§‹åŒ–å‘é‡ï¼ˆIVï¼‰**ï¼šæ¯æ¬¡åŠ å¯†ç”Ÿæˆéšæœº IV
- **åŠ å¯†å¼ºåº¦**ï¼š256 ä½å¯†é’¥ï¼Œå†›äº‹çº§åŠ å¯†

### 3. HTTPS Only

```typescript
// åªåŠ è½½ HTTPS é¡µé¢
await this.browserView.webContents.loadURL('https://www.douyin.com/');

// Cookie è®¾ç½®ä¸º secureï¼ˆä»… HTTPS ä¼ è¾“ï¼‰
cookie.secure = true;
```

## ğŸ“ å®Œæ•´ä»£ç æµç¨‹ç¤ºä¾‹

### ç”¨æˆ·ç‚¹å‡»"ç™»å½•"æŒ‰é’®

```typescript
// æ¸²æŸ“è¿›ç¨‹ï¼ˆVueï¼‰
async function handleLogin() {
  try {
    const account = await window.electronAPI.douyinOpenLogin();
    if (account) {
      ElMessage.success(`æ¬¢è¿ï¼Œ${account.nickname}ï¼`);
    }
  } catch (error) {
    ElMessage.error('ç™»å½•å¤±è´¥');
  }
}
```

### ä¸»è¿›ç¨‹å¤„ç†ç™»å½•

```typescript
// electron/ipc/handlers.ts
ipcMain.handle('douyin:openLogin', async (event) => {
  const mainWindow = BrowserWindow.fromWebContents(event.sender);
  
  return new Promise((resolve, reject) => {
    douyinLoginWindow.open(mainWindow, (account) => {
      // ç™»å½•æˆåŠŸå›è°ƒ
      resolve(account);
    });
  });
});
```

### ç™»å½•çª—å£é€»è¾‘

```typescript
// electron/douyin/login-window.ts

// 1. åˆ›å»ºçª—å£å¹¶åŠ è½½æŠ–éŸ³
async open(parentWindow, onSuccess) {
  this.onLoginSuccess = onSuccess;
  
  // åˆ›å»º BrowserView
  this.browserView = new BrowserView({
    webPreferences: {
      partition: 'persist:douyin'
    }
  });
  
  // ç›‘å¬å¯¼èˆª
  this.browserView.webContents.on('did-navigate', async (_, url) => {
    await this.checkLoginSuccess(url);
  });
  
  // åŠ è½½æŠ–éŸ³
  await this.browserView.webContents.loadURL('https://www.douyin.com/');
}

// 2. æ£€æµ‹ç™»å½•æˆåŠŸ
async checkLoginSuccess(url) {
  // URL æ£€æŸ¥
  const isLoggedIn = 
    url.includes('douyin.com') &&
    !url.includes('login') &&
    !url.includes('passport');
    
  if (!isLoggedIn) return;
  
  // 3. è·å– Cookie
  const cookies = await cookieManager.getCookiesFromSession('persist:douyin');
  
  // 4. è·å–ç”¨æˆ·ä¿¡æ¯
  const userInfo = await this.getUserInfo();
  
  // 5. ä¿å­˜è´¦å·
  const account = {
    nickname: userInfo.nickname,
    uid: userInfo.uid,
    cookies: cookies,
    loginTime: Date.now()
  };
  
  await cookieManager.saveAccount(account);
  
  // 6. é€šçŸ¥æˆåŠŸ
  this.onLoginSuccess(account);
  
  // 7. å…³é—­çª—å£
  this.close();
}

// 3. è·å–ç”¨æˆ·ä¿¡æ¯
async getUserInfo() {
  // åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ JS
  return await this.browserView.webContents.executeJavaScript(`
    (function() {
      // ä»å…¨å±€å˜é‡è·å–
      if (window.__INITIAL_STATE__?.user) {
        return {
          nickname: window.__INITIAL_STATE__.user.userInfo.nickname,
          uid: window.__INITIAL_STATE__.user.userInfo.uid
        };
      }
      
      // ä» localStorage è·å–
      const userInfo = JSON.parse(localStorage.getItem('userInfo'));
      if (userInfo) {
        return {
          nickname: userInfo.nickname,
          uid: userInfo.uid
        };
      }
      
      return null;
    })();
  `);
}
```

## ğŸ¯ å…³é”®ä¼˜åŠ¿

### 1. çœŸå®æµè§ˆå™¨ç¯å¢ƒ

âœ… æ”¯æŒæ‰€æœ‰ç™»å½•æ–¹å¼ï¼ˆæ‰«ç ã€å¯†ç ã€çŸ­ä¿¡ï¼‰  
âœ… æ”¯æŒéªŒè¯ç   
âœ… æ”¯æŒäºŒæ¬¡éªŒè¯  
âœ… å®Œå…¨æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸º  

### 2. Cookie è‡ªåŠ¨ç®¡ç†

âœ… è‡ªåŠ¨è·å–  
âœ… åŠ å¯†å­˜å‚¨  
âœ… è‡ªåŠ¨æ³¨å…¥  
âœ… è¿‡æœŸæ£€æµ‹  

### 3. è·¨çª—å£å…±äº«

âœ… ç™»å½•ä¸€æ¬¡ï¼Œå…¨å±€å¯ç”¨  
âœ… Session æŒä¹…åŒ–  
âœ… åº”ç”¨é‡å¯åä»æœ‰æ•ˆ  

### 4. å®‰å…¨å¯é 

âœ… Context Isolation  
âœ… Cookie åŠ å¯†  
âœ… HTTPS Only  
âœ… åŒæºç­–ç•¥  

## ğŸ”§ è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ Cookie

```typescript
// åœ¨ä¸»è¿›ç¨‹ä¸­
const cookies = await session
  .fromPartition('persist:douyin')
  .cookies.get({});
  
console.log('æ‰€æœ‰ Cookie:', cookies);
```

### æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯

```typescript
// åœ¨ BrowserView çš„æ§åˆ¶å°ä¸­æ‰§è¡Œ
window.__INITIAL_STATE__
localStorage.getItem('userInfo')
document.cookie
```

### ç›‘å¬ Cookie å˜åŒ–

```typescript
session.fromPartition('persist:douyin')
  .cookies.on('changed', (event, cookie, cause, removed) => {
    console.log('Cookie å˜åŒ–:', cookie.name, cause, removed);
  });
```

## ğŸ“š æ€»ç»“

**æ ¸å¿ƒåŸç†**ï¼š
1. ä½¿ç”¨ BrowserView åŠ è½½çœŸå®çš„æŠ–éŸ³ç½‘ç«™
2. ç›‘å¬ URL å˜åŒ–åˆ¤æ–­ç™»å½•æˆåŠŸ
3. é€šè¿‡ executeJavaScript è·å–ç”¨æˆ·ä¿¡æ¯
4. ä» Session ä¸­æå– Cookie
5. åŠ å¯†å­˜å‚¨åˆ°æœ¬åœ°
6. éœ€è¦æ—¶è‡ªåŠ¨æ³¨å…¥ Cookie

**å…³é”®æŠ€æœ¯**ï¼š
- Electron BrowserView
- Session Partition
- executeJavaScript
- Cookie API
- AES-256-CBC åŠ å¯†

**å®‰å…¨ä¿éšœ**ï¼š
- Context Isolation
- Cookie åŠ å¯†
- HTTPS Only
- æœ€å°æƒé™åŸåˆ™

è¿™å¥—æ–¹æ¡ˆæ—¢ä¿è¯äº†ç”¨æˆ·ä½“éªŒï¼ˆçœŸå®æµè§ˆå™¨ç™»å½•ï¼‰ï¼Œåˆä¿è¯äº†å®‰å…¨æ€§ï¼ˆCookie åŠ å¯†ã€æƒé™éš”ç¦»ï¼‰ï¼Œæ˜¯ Electron åº”ç”¨ä¸­å®ç°ç¬¬ä¸‰æ–¹ç™»å½•çš„æœ€ä½³å®è·µï¼ğŸ‰

