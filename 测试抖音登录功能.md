# 🧪 测试抖音登录 & Cookie 持久化功能

## 🚀 快速开始

### 步骤 1: 启动应用

```bash
npm run electron:dev
```

等待应用启动完成，应该看到登录页面。

---

### 步骤 2: 登录系统

在登录页面输入任意邮箱和密码（开发模式）：

- **邮箱**: `test@example.com`
- **密码**: `123456`

点击"登录"按钮，自动跳转到 Dashboard。

---

### 步骤 3: 进入抖音账号管理

1. 点击左侧导航栏的 **"设置"**（齿轮图标）
2. 点击 **"抖音账号"** Tab（第一个标签页）

应该看到：
```
┌───────────────────────────────────┐
│   抖音账号管理                ⓘ    │
├───────────────────────────────────┤
│                                   │
│         👤                         │
│     尚未登录抖音账号               │
│                                   │
│   ┌─────────────────────┐        │
│   │  🌐 登录抖音账号    │        │
│   └─────────────────────┘        │
└───────────────────────────────────┘
```

---

### 步骤 4: 测试抖音登录

#### 4.1 点击"登录抖音账号"按钮

应该会弹出一个新窗口，加载抖音官网。

#### 4.2 在新窗口中登录

**方式 1: 扫码登录（推荐）**
- 使用抖音 App 扫描二维码
- 确认登录

**方式 2: 账号密码登录**
- 输入手机号
- 输入验证码或密码
- 完成登录

#### 4.3 等待自动检测

登录成功后：
- ✅ 登录窗口自动关闭（约 1-2 秒后）
- ✅ 主窗口显示"登录成功"提示
- ✅ 账号信息自动加载

如果窗口没有自动关闭，可以手动关闭后点击主窗口的"刷新"按钮。

---

### 步骤 5: 验证登录成功

登录成功后，应该看到：

```
┌───────────────────────────────────┐
│   抖音账号管理                ⓘ    │
├───────────────────────────────────┤
│                                   │
│  👤  [你的抖音昵称]                │
│      UID: [你的抖音ID]             │
│      登录时间: 2025-11-26 14:30   │
│                                   │
│  ─────────────────────────────────│
│                                   │
│  Cookie 状态: ✅ 有效  🔄 刷新    │
│                                   │
│  ─────────────────────────────────│
│                                   │
│   [ 退出登录 ]                     │
└───────────────────────────────────┘
```

✅ **说明登录功能正常！**

---

### 步骤 6: 测试 Cookie 持久化

这是最重要的测试！

#### 6.1 关闭应用

在主窗口按 `Ctrl+C` 或直接关闭窗口。

#### 6.2 检查 Cookie 文件

**Windows**:
```bash
# 打开文件管理器，导航到：
C:\Users\<你的用户名>\AppData\Roaming\douyin\douyin\cookies.enc

# 或使用命令行：
dir %APPDATA%\douyin\douyin\cookies.enc
```

**macOS**:
```bash
ls ~/Library/Application\ Support/douyin/douyin/cookies.enc
```

**Linux**:
```bash
ls ~/.config/douyin/douyin/cookies.enc
```

✅ **应该看到 `cookies.enc` 文件存在**

文件内容类似（加密后）：
```
a1b2c3d4e5f6...1234567890abcdef:3f4e5d6c...9a8b7c6d
```

#### 6.3 重新启动应用

```bash
npm run electron:dev
```

#### 6.4 验证自动恢复

1. 登录系统（`test@example.com` / `123456`）
2. 进入"设置" → "抖音账号"

✅ **应该直接看到你的账号信息！**
✅ **不需要重新登录！**
✅ **Cookie 状态应该显示"有效"**

🎉 **Cookie 持久化成功！**

---

### 步骤 7: 测试 Cookie 状态刷新

1. 在"抖音账号"页面
2. 点击"刷新"按钮（Cookie 状态旁边）

应该看到：
- ⏳ 按钮显示 loading 状态
- ✅ 刷新完成后显示状态（"有效"或"失效"）

---

### 步骤 8: 测试退出登录

1. 点击"退出登录"按钮
2. 在确认对话框中点击"确定"

应该看到：
- ✅ 账号信息消失
- ✅ 恢复到"尚未登录"状态
- ✅ Cookie 文件被删除

验证文件已删除：
```bash
# Windows
dir %APPDATA%\douyin\douyin\cookies.enc
# 应该显示 "找不到文件"

# macOS/Linux
ls ~/.config/douyin/douyin/cookies.enc
# 应该显示 "No such file or directory"
```

---

## 🎯 完整测试检查清单

### 功能测试

- [ ] 应用正常启动
- [ ] 可以进入"抖音账号"管理页面
- [ ] 点击"登录抖音账号"打开新窗口
- [ ] 新窗口加载抖音官网
- [ ] 可以在新窗口中完成登录
- [ ] 登录成功后窗口自动关闭
- [ ] 主界面显示账号信息（昵称、UID）
- [ ] 显示登录时间
- [ ] Cookie 状态显示"有效"

### Cookie 持久化测试

- [ ] 登录后关闭应用
- [ ] Cookie 文件 `cookies.enc` 存在
- [ ] 重新启动应用
- [ ] 账号信息自动恢复
- [ ] 不需要重新登录
- [ ] Cookie 状态仍然显示"有效"

### Cookie 管理测试

- [ ] 可以刷新 Cookie 状态
- [ ] 退出登录功能正常
- [ ] 退出后 Cookie 文件被删除
- [ ] 退出后显示"尚未登录"状态

### 边界情况测试

- [ ] 关闭登录窗口（不登录）不会报错
- [ ] 多次点击"登录"按钮不会创建多个窗口
- [ ] Cookie 过期后显示"失效"状态
- [ ] 失效后可以点击"重新登录"

---

## 🐛 可能遇到的问题

### 问题 1: 登录窗口打开后显示空白

**可能原因**:
- 网络问题
- 抖音官网访问受限

**解决方法**:
1. 检查网络连接
2. 尝试在浏览器中访问 `https://www.douyin.com`
3. 等待页面加载完成

---

### 问题 2: 登录后窗口不自动关闭

**可能原因**:
- 未检测到登录成功的特征

**解决方法**:
1. 手动关闭登录窗口
2. 在主窗口点击"刷新"按钮
3. 或者重新点击"登录抖音账号"

**排查**:
- 打开开发者工具（F12）
- 查看主进程日志（Terminal 窗口）
- 查找 "检测到登录成功" 或错误信息

---

### 问题 3: 重启后没有自动恢复登录

**可能原因**:
- Cookie 文件不存在或损坏
- 解密失败

**解决方法**:
1. 检查 Cookie 文件是否存在
2. 查看主进程日志中的错误信息
3. 尝试重新登录

**排查**:
```bash
# 查看文件是否存在
# Windows
dir %APPDATA%\douyin\douyin\cookies.enc

# macOS/Linux
ls ~/.config/douyin/douyin/cookies.enc

# 如果文件不存在，说明保存失败
# 如果文件存在但无法恢复，可能是解密失败
```

---

### 问题 4: Cookie 状态显示"失效"

**这是正常的！**

Cookie 有生命周期，可能会过期。

**解决方法**:
- 点击"重新登录"按钮
- 重新完成登录流程

**说明**:
- 抖音的 Cookie 通常 7-30 天过期
- 如果频繁失效（< 7 天），可能需要检查验证逻辑

---

### 问题 5: 开发环境 `window.electronAPI` 未定义

**原因**: 
在纯浏览器环境（`npm run dev`）中，`electronAPI` 不可用。

**解决**:
必须使用 Electron 环境：
```bash
npm run electron:dev
```

---

## 📊 验证数据

### Cookie 文件格式

加密后的 Cookie 文件内容示例：

```
a1b2c3d4e5f6789012345678:3f4e5d6c7b8a9f0e1d2c3b4a5f6e7d8c9b0a1f2e3d4c
│                          │
│                          └─ 加密后的数据（hex）
└─ 随机 IV（16 字节，hex）
```

### 解密后的数据结构（不要尝试手动解密！）

```json
{
  "nickname": "测试用户",
  "uid": "1234567890",
  "avatarUrl": "https://...",
  "cookies": [
    {
      "name": "sessionid",
      "value": "abc123...",
      "domain": ".douyin.com",
      "path": "/",
      "secure": true,
      "httpOnly": true,
      "expirationDate": 1735200000
    },
    // ... 更多 Cookie
  ],
  "loginTime": 1732608600000,
  "lastActiveTime": 1732608600000
}
```

---

## 🎉 测试成功的标志

当你完成所有测试后，应该确认：

✅ **功能完整性**
- 可以成功登录抖音账号
- 账号信息正确显示
- Cookie 状态监控正常
- 可以退出登录

✅ **持久化可靠性**
- 应用重启后自动恢复
- Cookie 文件正确保存
- 加密存储安全

✅ **用户体验**
- 界面友好易用
- 操作流程顺畅
- 错误提示清晰

✅ **安全性**
- Cookie 加密存储
- 退出后数据清除
- Session 独立隔离

---

## 🚀 下一步

测试通过后，可以继续开发：

1. **直播监控功能**
   - 使用保存的 Cookie 监听直播间
   - 实时抓取弹幕

2. **弹幕过滤**
   - 根据用户等级过滤
   - 根据礼物价值过滤

3. **自动打印**
   - 接收弹幕后自动打印
   - 支持自定义模板

---

## 📞 遇到问题？

如果遇到问题：

1. **查看日志**
   - Terminal 窗口的主进程日志
   - F12 开发者工具的渲染进程日志

2. **检查文件**
   - Cookie 文件是否存在
   - 文件权限是否正确

3. **验证环境**
   - Node.js 版本
   - Electron 版本
   - 依赖包是否完整安装

4. **查看文档**
   - `docs/抖音登录Cookie持久化功能说明.md`
   - 详细的技术实现说明

---

**祝测试顺利！🎉**

