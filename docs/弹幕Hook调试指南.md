# å¼¹å¹• Hook è°ƒè¯•æŒ‡å—

## ğŸ” é—®é¢˜è¯Šæ–­

å½“ç›´æ’­é—´çª—å£æ­£å¸¸æ‰“å¼€ä½†æ²¡æœ‰å¼¹å¹•è¾“å‡ºæ—¶ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤æ’æŸ¥ï¼š

## âœ… éªŒè¯æ­¥éª¤

### æ­¥éª¤ 1: ç¡®è®¤é¡µé¢åŠ è½½æˆåŠŸ

**æœŸæœ›æ—¥å¿—ï¼š**
```
ğŸ¥ å¼€å§‹ç›‘æ§ç›´æ’­é—´: 85335374228
ğŸ“ åŠ è½½åœ°å€: https://www.douyin.com/follow/live/85335374228
ğŸ”§ å¼€å§‹è®¾ç½®æ¶ˆæ¯æ‹¦æˆªå™¨...
âœ… æ¶ˆæ¯æ‹¦æˆªå™¨è®¾ç½®å®Œæˆ
âœ… å¼€å§‹åŠ è½½ç›´æ’­é—´é¡µé¢ï¼ˆä½¿ç”¨å·²ä¿å­˜çš„ Cookieï¼‰
ğŸ”„ ç›´æ’­é—´é¡µé¢å¼€å§‹åŠ è½½: https://www.douyin.com/follow/live/...
âœ… ç›´æ’­é—´é¡µé¢åŠ è½½å®Œæˆ: https://www.douyin.com/follow/live/...
```

**å¦‚æœçœ‹åˆ°ï¼š**
- âœ… é¡µé¢åŠ è½½å®Œæˆ - ç»§ç»­ä¸‹ä¸€æ­¥
- âŒ é¡µé¢åŠ è½½å¤±è´¥ - æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ Cookie

### æ­¥éª¤ 2: ç¡®è®¤ WebSocket Hook æ³¨å…¥æˆåŠŸ

**æœŸæœ›æ—¥å¿—ï¼š**
```
ğŸ¯ å‡†å¤‡æ³¨å…¥ WebSocket Hook åˆ°: https://www.douyin.com/follow/live/...
âœ… WebSocket Hook è„šæœ¬å·²æ³¨å…¥
```

æˆ–è€…ï¼š
```
ğŸ”„ è¡¥å……æ³¨å…¥ WebSocket Hook
âœ… è¡¥å……æ³¨å…¥å®Œæˆ
```

**å¦‚æœæ²¡æœ‰çœ‹åˆ°ï¼š**
- å¯èƒ½é¡µé¢è·³è½¬å¤ªå¿«ï¼ŒHook è¿˜æ²¡æ¥å¾—åŠæ³¨å…¥
- å°è¯•é‡æ–°å¯åŠ¨ç›‘æ§

### æ­¥éª¤ 3: ç¡®è®¤ WebSocket è¿æ¥å»ºç«‹

**æœŸæœ›æ—¥å¿—ï¼š**
```
[ç›´æ’­é—´] ğŸ¯ WebSocket Hook å¼€å§‹æ³¨å…¥
[ç›´æ’­é—´] âœ… WebSocket Hook å®‰è£…å®Œæˆ
[ç›´æ’­é—´] ğŸ”— WebSocket å·²è¿æ¥: wss://webcast5-ws-web-hl.douyin.com/...
```

**å¦‚æœæ²¡æœ‰çœ‹åˆ°ï¼š**
- ç›´æ’­é—´å¯èƒ½ä½¿ç”¨äº†å…¶ä»–æŠ€æœ¯æ ˆï¼ˆä¸æ˜¯ WebSocketï¼‰
- Cookie å¯èƒ½å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
- ç›´æ’­é—´å¯èƒ½æ²¡æœ‰å¼€æ’­

### æ­¥éª¤ 4: ç¡®è®¤æ¥æ”¶åˆ° WebSocket æ¶ˆæ¯

**æœŸæœ›æ—¥å¿—ï¼š**
```
[ç›´æ’­é—´] ğŸ“Š WebSocket ç»Ÿè®¡: å·²æ¥æ”¶ 1 æ¡äºŒè¿›åˆ¶æ¶ˆæ¯
[ç›´æ’­é—´] ğŸ“Š WebSocket ç»Ÿè®¡: å·²æ¥æ”¶ 11 æ¡äºŒè¿›åˆ¶æ¶ˆæ¯
```

**å¦‚æœæ²¡æœ‰çœ‹åˆ°ï¼š**
- ç›´æ’­é—´æš‚æ—¶æ²¡æœ‰å¼¹å¹•æ´»åŠ¨
- ç­‰å¾…ä¸€æ®µæ—¶é—´æˆ–æ¢ä¸€ä¸ªçƒ­é—¨ç›´æ’­é—´

### æ­¥éª¤ 5: ç¡®è®¤ Protobuf è§£ææˆåŠŸ

**æœŸæœ›æ—¥å¿—ï¼š**
```
ğŸ“¦ [Protobuf] æ”¶åˆ°æ¶ˆæ¯: payloadType=msg, logId=...
   ğŸ“‹ æ¶ˆæ¯æ•°é‡: 2
   â”œâ”€ æ¶ˆæ¯ 1/2: WebcastChatMessage
   â”‚  âœ“ [ç”¨æˆ·æ˜µç§°] æ¶ˆæ¯å†…å®¹
   âœ… è§£æå®Œæˆï¼š2 æ¡æœ‰æ•ˆå¼¹å¹•
```

**å¦‚æœæ²¡æœ‰çœ‹åˆ°ï¼š**
- å¯èƒ½éƒ½æ˜¯å¿ƒè·³åŒ…ï¼ˆpayloadType=hbï¼‰ï¼Œè¿™æ˜¯æ­£å¸¸çš„
- ç­‰å¾…å®é™…çš„å¼¹å¹•æ¶ˆæ¯ï¼ˆpayloadType=msgï¼‰

### æ­¥éª¤ 6: ç¡®è®¤å¼¹å¹•è¯¦ç»†è¾“å‡º

**æœŸæœ›æ—¥å¿—ï¼š**
```
ğŸ’¬ [14:35:21] èŠå¤©æ¶ˆæ¯
   ğŸ‘¤ ç”¨æˆ·æ˜µç§° (Lv.18)
   å†…å®¹: æ¶ˆæ¯å†…å®¹
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**å¦‚æœçœ‹åˆ°ï¼š**
- âœ… å¼¹å¹•æ­£å¸¸è¾“å‡º - åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼
- âŒ æ²¡æœ‰è¯¦ç»†è¾“å‡º - æ£€æŸ¥ `logBarrageToConsole` æ–¹æ³•

## ğŸ› å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: é¡µé¢åå¤åŠ è½½

**ç°è±¡ï¼š**
```
ğŸ”„ ç›´æ’­é—´é¡µé¢å¼€å§‹åŠ è½½...
ğŸ”„ ç›´æ’­é—´é¡µé¢å¼€å§‹åŠ è½½...
ğŸ”„ ç›´æ’­é—´é¡µé¢å¼€å§‹åŠ è½½...
ï¼ˆæ— é™å¾ªç¯ï¼‰
```

**åŸå› ï¼š**
- é¡µé¢å†…éƒ¨è·³è½¬æˆ–é‡å®šå‘
- æŸäº›èµ„æºåŠ è½½è§¦å‘äº†æ–°çš„å¯¼èˆª

**è§£å†³æ–¹æ¡ˆï¼š**
- å·²ä¼˜åŒ–ï¼šç°åœ¨è¿‡æ»¤æ‰ `bytedance://` åè®®çš„åŠ è½½
- é¡µé¢æœ€ç»ˆä¼šç¨³å®šä¸‹æ¥

### é—®é¢˜ 2: ERR_BLOCKED_BY_CSP é”™è¯¯

**ç°è±¡ï¼š**
```
âŒ ç›´æ’­é—´é¡µé¢åŠ è½½å¤±è´¥: {
  errorCode: -30,
  errorDescription: 'ERR_BLOCKED_BY_CSP',
  url: 'bytedance://dispatch_message/'
}
```

**åŸå› ï¼š**
- æŠ–éŸ³å†…éƒ¨ä½¿ç”¨ `bytedance://` åè®®è¿›è¡Œé€šä¿¡
- è¢« CSP (Content Security Policy) æ‹¦æˆª

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šè¿™ä¸ªé”™è¯¯ä¼šè¢«è‡ªåŠ¨è¿‡æ»¤ï¼Œä¸å½±å“åŠŸèƒ½
- è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œå¯ä»¥å¿½ç•¥

### é—®é¢˜ 3: Hook æ²¡æœ‰æ³¨å…¥

**ç°è±¡ï¼š**
- æ²¡æœ‰çœ‹åˆ° "WebSocket Hook å¼€å§‹æ³¨å…¥" æ—¥å¿—
- æ²¡æœ‰çœ‹åˆ° "WebSocket å·²è¿æ¥" æ—¥å¿—

**å¯èƒ½åŸå› ï¼š**
1. é¡µé¢è·³è½¬å¤ªå¿«
2. è„šæœ¬æ³¨å…¥æ—¶æœºä¸å¯¹
3. é¡µé¢ä½¿ç”¨äº† iframe

**è§£å†³æ–¹æ¡ˆï¼š**
```javascript
// åœ¨ç›´æ’­é—´çª—å£æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆCtrl+Shift+Iï¼‰
// åœ¨ Console ä¸­æ£€æŸ¥ï¼š
console.log(window.__DOUYIN_WS_HOOKED__)
// åº”è¯¥è¾“å‡º: true

// å¦‚æœè¾“å‡º undefinedï¼Œè¯´æ˜ Hook æ²¡æœ‰æ³¨å…¥
// å°è¯•æ‰‹åŠ¨åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰
```

### é—®é¢˜ 4: WebSocket è¿æ¥ä½†æ²¡æœ‰æ¶ˆæ¯

**ç°è±¡ï¼š**
```
[ç›´æ’­é—´] ğŸ”— WebSocket å·²è¿æ¥: wss://...
ï¼ˆä½†æ²¡æœ‰åç»­çš„æ¶ˆæ¯ç»Ÿè®¡ï¼‰
```

**å¯èƒ½åŸå› ï¼š**
1. ç›´æ’­é—´æ²¡æœ‰å¼¹å¹•æ´»åŠ¨
2. WebSocket æ¶ˆæ¯å¤„ç†å‡½æ•°æ²¡æœ‰æ­£ç¡®æ•è·

**è§£å†³æ–¹æ¡ˆï¼š**
1. **ç­‰å¾…å¼¹å¹•**ï¼šåœ¨çƒ­é—¨æ—¶æ®µæˆ–çƒ­é—¨ç›´æ’­é—´æµ‹è¯•
2. **æ‰‹åŠ¨å‘é€å¼¹å¹•**ï¼šè‡ªå·±åœ¨ç›´æ’­é—´å‘æ¡æ¶ˆæ¯æµ‹è¯•
3. **æ£€æŸ¥ Hook**ï¼šåœ¨ç›´æ’­é—´çª—å£å¼€å‘è€…å·¥å…·ä¸­ï¼š
   ```javascript
   // æ£€æŸ¥ WebSocket æ˜¯å¦è¢«æ­£ç¡® Hook
   console.log(window.WebSocket.toString())
   // åº”è¯¥çœ‹åˆ°æˆ‘ä»¬æ³¨å…¥çš„ä»£ç†ä»£ç 
   ```

### é—®é¢˜ 5: åªæœ‰å¿ƒè·³åŒ…æ²¡æœ‰å¼¹å¹•

**ç°è±¡ï¼š**
```
ğŸ“¦ [Protobuf] æ”¶åˆ°æ¶ˆæ¯: payloadType=hb, logId=...
ğŸ“¦ [Protobuf] æ”¶åˆ°æ¶ˆæ¯: payloadType=hb, logId=...
ï¼ˆä¸€ç›´æ˜¯ hbï¼Œæ²¡æœ‰ msgï¼‰
```

**åŸå› ï¼š**
- å¿ƒè·³åŒ…ï¼ˆheartbeatï¼‰æ˜¯æ­£å¸¸çš„ï¼Œç”¨äºä¿æŒè¿æ¥
- åªæœ‰å®é™…çš„å¼¹å¹•æ‰ä¼šæ˜¯ `payloadType=msg`

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… è¿™æ˜¯æ­£å¸¸çš„ï¼ç»§ç»­ç­‰å¾…
- åœ¨ç›´æ’­é—´å‘æ¡å¼¹å¹•æµ‹è¯•
- æ¢ä¸€ä¸ªæ›´æ´»è·ƒçš„ç›´æ’­é—´

## ğŸ”§ é«˜çº§è°ƒè¯•

### æ–¹æ³• 1: åœ¨ç›´æ’­é—´çª—å£æŸ¥çœ‹åŸå§‹ WebSocket

1. ç‚¹å‡»ç›´æ’­é—´çª—å£
2. æŒ‰ `Ctrl + Shift + I` (Windows) æˆ– `Cmd + Option + I` (macOS)
3. åˆ‡æ¢åˆ° **Network** æ ‡ç­¾
4. åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰
5. ç­›é€‰ **WS** (WebSocket)
6. åº”è¯¥çœ‹åˆ° WebSocket è¿æ¥

### æ–¹æ³• 2: æŸ¥çœ‹ WebSocket åŸå§‹æ¶ˆæ¯

åœ¨ Network -> WS ä¸­ï¼š
1. ç‚¹å‡» WebSocket è¿æ¥
2. åˆ‡æ¢åˆ° **Messages** æ ‡ç­¾
3. åº”è¯¥çœ‹åˆ°å¤§é‡çš„äºŒè¿›åˆ¶æ¶ˆæ¯ï¼ˆBinary Messageï¼‰

### æ–¹æ³• 3: æ‰‹åŠ¨æµ‹è¯• Hook

åœ¨ç›´æ’­é—´çª—å£çš„ Console ä¸­æ‰§è¡Œï¼š

```javascript
// 1. æ£€æŸ¥ Hook æ˜¯å¦å®‰è£…
console.log('Hook installed:', window.__DOUYIN_WS_HOOKED__)

// 2. æ£€æŸ¥æ¶ˆæ¯è®¡æ•°
console.log('Message count:', window.__WS_MESSAGE_COUNT__)

// 3. æµ‹è¯• console.log æ˜¯å¦èƒ½ä¼ é€’åˆ°ä¸»è¿›ç¨‹
console.log('__BARRAGE_BINARY__:test')
// ä¸»è¿›ç¨‹åº”è¯¥å°è¯•è§£æè¿™ä¸ª "test" å¹¶æŠ¥é”™ï¼ˆè¿™æ˜¯é¢„æœŸçš„ï¼‰
```

### æ–¹æ³• 4: ä¸´æ—¶å¢åŠ è¯¦ç»†æ—¥å¿—

ç¼–è¾‘ `electron/douyin/live-monitor.ts`ï¼Œåœ¨ `setupInterceptor` æ–¹æ³•ä¸­ï¼š

```typescript
this.browserView.webContents.on('console-message', async (_event, level, message) => {
  // ğŸ”´ ä¸´æ—¶ï¼šæ‰“å°æ‰€æœ‰ console æ¶ˆæ¯
  console.log('[ALL CONSOLE]', level, message)
  
  // ... åŸæœ‰ä»£ç  ...
})
```

è¿™æ ·å¯ä»¥çœ‹åˆ°ç›´æ’­é—´é¡µé¢çš„æ‰€æœ‰ console è¾“å‡ºã€‚

## ğŸ“Š å®Œæ•´çš„æ­£å¸¸æ—¥å¿—ç¤ºä¾‹

```
ğŸ¥ å¼€å§‹ç›‘æ§ç›´æ’­é—´: 85335374228
ğŸ“ åŠ è½½åœ°å€: https://www.douyin.com/follow/live/85335374228
ğŸ”§ å¼€å§‹è®¾ç½®æ¶ˆæ¯æ‹¦æˆªå™¨...
âœ… æ¶ˆæ¯æ‹¦æˆªå™¨è®¾ç½®å®Œæˆ
âœ… å¼€å§‹åŠ è½½ç›´æ’­é—´é¡µé¢ï¼ˆä½¿ç”¨å·²ä¿å­˜çš„ Cookieï¼‰
ğŸ”„ ç›´æ’­é—´é¡µé¢å¼€å§‹åŠ è½½: https://www.douyin.com/follow/live/85335374228
ğŸ¯ å‡†å¤‡æ³¨å…¥ WebSocket Hook åˆ°: https://www.douyin.com/follow/live/85335374228
âœ… WebSocket Hook è„šæœ¬å·²æ³¨å…¥
âœ… ç›´æ’­é—´é¡µé¢åŠ è½½å®Œæˆ: https://www.douyin.com/follow/live/85335374228
[ç›´æ’­é—´] ğŸ¯ WebSocket Hook å¼€å§‹æ³¨å…¥
[ç›´æ’­é—´] âœ… WebSocket Hook å®‰è£…å®Œæˆ
[ç›´æ’­é—´] ğŸ”— WebSocket å·²è¿æ¥: wss://webcast5-ws-web-hl.douyin.com/webcast/im/push/v2/?...
[ç›´æ’­é—´] ğŸ“Š WebSocket ç»Ÿè®¡: å·²æ¥æ”¶ 1 æ¡äºŒè¿›åˆ¶æ¶ˆæ¯

ğŸ“¦ [Protobuf] æ”¶åˆ°æ¶ˆæ¯: payloadType=msg, logId=202411271234...
   ğŸ“‹ æ¶ˆæ¯æ•°é‡: 3
   â”œâ”€ æ¶ˆæ¯ 1/3: WebcastChatMessage
   â”‚  âœ“ [å¯çˆ±çš„å°çŒ«å’ª] ä¸»æ’­å¥½å‰å®³å•Š
   â”œâ”€ æ¶ˆæ¯ 2/3: WebcastGiftMessage
   â”‚  âœ“ [åœŸè±ªç”¨æˆ·] ç«ç‘°
   â”œâ”€ æ¶ˆæ¯ 3/3: WebcastMemberMessage
   â”‚  âœ“ [è·¯äººç”²] è¿›å…¥ç›´æ’­é—´
   âœ… è§£æå®Œæˆï¼š3 æ¡æœ‰æ•ˆå¼¹å¹•

ğŸ’¬ [14:35:21] èŠå¤©æ¶ˆæ¯
   ğŸ‘¤ å¯çˆ±çš„å°çŒ«å’ª (Lv.18)
   å†…å®¹: ä¸»æ’­å¥½å‰å®³å•Š
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ [14:35:22] ç¤¼ç‰©æ¶ˆæ¯
   ğŸ‘¤ åœŸè±ªç”¨æˆ· (Lv.65)
   ç¤¼ç‰©: ç«ç‘° x1
   ä»·å€¼: 1 æŠ–å¸
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ [14:35:23] è¿›å…¥ç›´æ’­é—´
   ğŸ‘¤ è·¯äººç”² (Lv.5)
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[ç›´æ’­é—´] ğŸ“Š WebSocket ç»Ÿè®¡: å·²æ¥æ”¶ 11 æ¡äºŒè¿›åˆ¶æ¶ˆæ¯
ï¼ˆç»§ç»­æ¥æ”¶æ›´å¤šå¼¹å¹•...ï¼‰
```

## ğŸ¯ ä¸‹ä¸€æ­¥

å¦‚æœæŒ‰ç…§æœ¬æŒ‡å—æ“ä½œåä»ç„¶æ²¡æœ‰å¼¹å¹•è¾“å‡ºï¼š

1. **æˆªå›¾å®Œæ•´çš„æ§åˆ¶å°æ—¥å¿—**ï¼ˆä»å¯åŠ¨åˆ°ç°åœ¨çš„æ‰€æœ‰è¾“å‡ºï¼‰
2. **è®°å½•ç›´æ’­é—´åœ°å€**ï¼ˆç¡®ä¿ç›´æ’­é—´æ­£åœ¨ç›´æ’­ï¼‰
3. **è®°å½•æ“ä½œæ­¥éª¤**ï¼ˆå…·ä½“åšäº†ä»€ä¹ˆï¼‰
4. **æä¾›é”™è¯¯ä¿¡æ¯**ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰

ç„¶åå¯ä»¥è¿›ä¸€æ­¥åˆ†æé—®é¢˜ã€‚

## ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

å¦‚æœå¼¹å¹•å¤ªå¤šå¯¼è‡´æ§åˆ¶å°åˆ·å±ï¼š

```typescript
// åœ¨ protobuf-parser-dycast.ts ä¸­å‡å°‘æ—¥å¿—
console.log(`ğŸ“¦ [Protobuf] æ”¶åˆ°æ¶ˆæ¯...`) // æ³¨é‡Šæ‰
// console.log(`   â”œâ”€ æ¶ˆæ¯ 1/3: ...`) // æ³¨é‡Šæ‰

// åªä¿ç•™å…³é”®çš„å¼¹å¹•è¾“å‡º
if (parsedMsg) {
    results.push(parsedMsg)
    // console.log(...) // æ³¨é‡Šæ‰è¯¦ç»†è¾“å‡º
}
```

```typescript
// åœ¨ live-monitor.ts ä¸­åªè¾“å‡ºå¼¹å¹•å†…å®¹ï¼Œä¸è¾“å‡ºæ ¼å¼åŒ–æ¡†
private logBarrageToConsole(barrage: BarrageData) {
  const timestamp = new Date(barrage.timestamp).toLocaleTimeString('zh-CN', { hour12: false })
  
  // ç®€åŒ–è¾“å‡ºï¼šä¸€è¡Œæå®š
  if (barrage.type === 'text') {
    console.log(`ğŸ’¬ [${timestamp}] ${barrage.nickname}: ${barrage.content}`)
  } else if (barrage.type === 'gift') {
    console.log(`ğŸ [${timestamp}] ${barrage.nickname} é€å‡º ${barrage.giftName} x${barrage.giftCount}`)
  }
  // ...
}
```


