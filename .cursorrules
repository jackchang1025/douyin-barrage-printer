# Douyin Barrage Crawler Rules

æ­¤æ–‡ä»¶å®šä¹‰äº†æŠ–éŸ³ç›´æ’­å¼¹å¹•ç›‘æ§é¡¹ç›®çš„æ ¸å¿ƒæ¶æ„è§„åˆ™å’Œå¼€å‘è§„èŒƒã€‚

## 1. æ ¸å¿ƒåŸåˆ™ (Core Principles)

- **ä¸¥ç¦ä½¿ç”¨ WebSocket Hook æ³¨å…¥**ï¼šä¸è¦å°è¯•é€šè¿‡æ³¨å…¥ JS (`window.WebSocket = ...`) æ¥æ‹¦æˆªå¼¹å¹•ã€‚ç”±äºæ—¶åºç«äº‰é—®é¢˜ï¼Œè¿™ç§æ–¹æ³•æä¸ç¨³å®šã€‚
- **å¿…é¡»ä½¿ç”¨ CDP (Chrome DevTools Protocol)**ï¼šå§‹ç»ˆä½¿ç”¨ Electron çš„ `webContents.debugger` API åœ¨ç½‘ç»œå±‚æ‹¦æˆª WebSocket å¸§ã€‚è¿™æ˜¯å”¯ä¸€è¢«éªŒè¯ä¸º 100% å¯é çš„æ–¹æ¡ˆã€‚
- **å•ä¸€èŒè´£**ï¼š
  - `cdp-interceptor.ts`: è´Ÿè´£ç½‘ç»œå±‚æ‹¦æˆªã€‚
  - `protobuf-parser-dycast.ts`: è´Ÿè´£äºŒè¿›åˆ¶è§£ç ã€‚
  - `barrage-handler.ts`: è´Ÿè´£ä¸šåŠ¡é€»è¾‘æ˜ å°„å’Œæ—¥å¿—ã€‚
  - `LiveRoom.vue`: è´Ÿè´£ UI å±•ç¤ºã€‚

## 2. æ¶æ„ä¸æ–‡ä»¶èŒè´£ (Architecture)

### åç«¯ (Electron Main Process)

| æ–‡ä»¶è·¯å¾„ | èŒè´£ | å…³é”®é€»è¾‘ |
|---------|------|---------|
| `electron/douyin/cdp-interceptor.ts` | **æ‹¦æˆªå™¨** | é™„åŠ  debugger; ç›‘å¬ `Network.webSocketFrameReceived`; è¯†åˆ« `webcast` URL; æ•è· opcode=2 çš„äºŒè¿›åˆ¶å¸§ã€‚ |
| `electron/douyin/protobuf-parser-dycast.ts` | **è§£ç å™¨** | ä½¿ç”¨ `dycast-model.ts` å®šä¹‰çš„ Protobuf ç»“æ„å°† ArrayBuffer è§£ç ä¸º JSON å¯¹è±¡ã€‚ |
| `electron/douyin/barrage-handler.ts` | **å¤„ç†å™¨** | æ¸…æ´—æ•°æ®; å°†åç«¯æ¶ˆæ¯ç±»å‹è½¬æ¢ä¸ºå‰ç«¯ç»Ÿä¸€æ ¼å¼; é€šè¿‡ IPC (`live-barrage:data`) å‘é€ã€‚ |
| `electron/douyin/live-monitor.ts` | **æ§åˆ¶å™¨** | ç®¡ç† BrowserWindow/BrowserView ç”Ÿå‘½å‘¨æœŸ; é›†æˆ CDP æ‹¦æˆªå™¨; å¤„ç† IPC å‘½ä»¤ã€‚ |

### å‰ç«¯ (Vue Renderer Process)

| æ–‡ä»¶è·¯å¾„ | èŒè´£ | å…³é”®é€»è¾‘ |
|---------|------|---------|
| `src/views/LiveRoom.vue` | **å±•ç¤ºå±‚** | ç›‘å¬ `electronAPI.onBarrageReceived`; å®ç°å¼¹å¹•æ»šåŠ¨é€»è¾‘ï¼ˆèŠå¤©æ»šåŠ¨ï¼Œé€šçŸ¥å›ºå®šï¼‰ã€‚ |
| `src/stores/barrage.ts` | **çŠ¶æ€å±‚** | ä½¿ç”¨ Pinia å­˜å‚¨å¼¹å¹•æ•°æ®ã€‚ |

## 3. æ¶ˆæ¯ç±»å‹æ˜ å°„è§„èŒƒ (Message Mapping)

åç«¯ (`barrage-handler.ts`) è§£æå‡ºçš„æ¶ˆæ¯ç±»å‹ä¸å‰ç«¯ (`LiveRoom.vue`) æœŸæœ›çš„ç±»å‹å¿…é¡»ä¸¥æ ¼å¯¹åº”ï¼š

| åŸå§‹æ¶ˆæ¯å†…å®¹ | åç«¯è½¬æ¢ç±»å‹ (Type) | å‰ç«¯å¤„ç†é€»è¾‘ | å›¾æ ‡ |
|-------------|-------------------|--------------|------|
| èŠå¤©æ¶ˆæ¯ | `text` | æ”¾å…¥ `chatBarrages` (æ»šåŠ¨æ˜¾ç¤º) | ğŸ’¬ |
| ç¤¼ç‰© | `gift` | æ”¾å…¥ `latestNotification` (åº•éƒ¨å›ºå®š) | ğŸ |
| è¿›å…¥ç›´æ’­é—´ | `follow` | æ”¾å…¥ `latestNotification` (åº•éƒ¨å›ºå®š) | ğŸ‘‹ |
| å…³æ³¨ä¸»æ’­ | `follow` | æ”¾å…¥ `latestNotification` (åº•éƒ¨å›ºå®š) | â¤ï¸ |
| ç‚¹èµ | `like` | æ”¾å…¥ `latestNotification` (åº•éƒ¨å›ºå®š) | ğŸ‘ |
| åˆ†äº« | `share` | æ”¾å…¥ `latestNotification` (åº•éƒ¨å›ºå®š) | ğŸ”— |

**æ³¨æ„**ï¼šå‰ç«¯ä¸è¦ä½¿ç”¨ `chat` ä½œä¸ºç±»å‹åˆ¤æ–­ï¼Œåç«¯ç»Ÿä¸€è¾“å‡ºä¸º `text`ã€‚å‰ç«¯ä¹Ÿä¸è¦åŒºåˆ† `member`/`social`ï¼Œåç«¯ç»Ÿä¸€è¾“å‡ºä¸º `follow`ï¼ˆé€šè¿‡ content å†…å®¹åŒºåˆ†ï¼‰ã€‚

## 4. å¼€å‘æŒ‡å— (Development Guide)

### æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹æ”¯æŒ
1. åœ¨ `dycast-model.ts` ä¸­æŸ¥æ‰¾æˆ–æ·»åŠ å¯¹åº”çš„ Protobuf å®šä¹‰ (`decodeXxxMessage`)ã€‚
2. åœ¨ `protobuf-parser-dycast.ts` çš„ `parseInnerMessage` ä¸­æ·»åŠ  `case` åˆ†æ”¯è¿›è¡Œè§£ç ã€‚
3. åœ¨ `barrage-handler.ts` çš„ `convertToBarrageData` ä¸­æ·»åŠ ç±»å‹æ˜ å°„ã€‚
4. åœ¨ `LiveRoom.vue` çš„ `latestNotification` æˆ– `chatBarrages` ä¸­æ·»åŠ æ˜¾ç¤ºé€»è¾‘ã€‚

### è°ƒè¯•æ–¹æ³•
- **å¼€å¯ DevTools**: åœ¨ `live-monitor.ts` ä¸­å–æ¶ˆæ³¨é‡Š `this.browserView.webContents.openDevTools({ mode: 'right' })`ã€‚
- **CDP æ—¥å¿—**: `cdp-interceptor.ts` ä¼šæ‰“å° `[CDP]` å¼€å¤´çš„æ—¥å¿—ï¼Œç”¨äºç¡®è®¤æ˜¯å¦æ•è·åˆ° WebSocketã€‚
- **å¼¹å¹•æ—¥å¿—**: `barrage-handler.ts` ä¼šæ‰“å°è¯¦ç»†çš„å¼¹å¹•å†…å®¹ã€‚

## 5. å¸¸è§é—®é¢˜ä¸ä¿®å¤

- **Q: æ— æ³•è·å–å¼¹å¹•ï¼Ÿ**
  - A: æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æ˜¾ç¤º `[CDP] ğŸ¯ æ•è·å¼¹å¹• WebSocket`ã€‚å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜ CDP æœªé™„åŠ æˆ– URL åŒ¹é…è§„åˆ™å¤±æ•ˆã€‚
  
- **Q: æ§åˆ¶å°å¤§é‡ console.assert é”™è¯¯ï¼Ÿ**
  - A: è¿™æ˜¯å› ä¸º Electron æ‰“å¼€äº† DevTools å¯¼è‡´çš„å†…éƒ¨æ–­è¨€é”™è¯¯ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒæˆ–ä¸éœ€è¦è°ƒè¯•æ—¶ï¼Œå…³é—­ DevTools å³å¯è§£å†³ã€‚

- **Q: åœæ­¢ç›‘æ§åæ•°æ®ä¸¢å¤±ï¼Ÿ**
  - A: `LiveRoom.vue` ä¸­çš„ `handleStop` å’Œ `onMonitoringStopped` ä¸åº”æ¸…ç©º `barrageStore` æˆ–é‡ç½®è®¡æ—¶å™¨æ•°å€¼ï¼Œåªåº”åœæ­¢è®¡æ—¶å™¨è¿è¡Œã€‚

