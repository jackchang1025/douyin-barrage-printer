# 测试弹幕 Hook 功能

## 🚀 快速开始

### 1. 启动开发服务器

```bash
npm run dev
```

这会启动两个进程：
- **Vite 开发服务器** (前端)
- **Electron 主进程** (后端)

### 2. 登录抖音账号

1. 在应用中点击「登录抖音」
2. 在弹出的窗口中扫码或输入账号密码登录
3. 登录成功后会显示用户信息

### 3. 开始监控直播间

#### 方法 1: 使用 LiveRoom.vue (BrowserView 方式)

1. 进入「弹幕监控」页面
2. 输入直播间地址，支持以下格式：
   ```
   https://live.douyin.com/123456789
   https://www.douyin.com/follow/live/123456789
   123456789  (纯数字)
   ```
3. 点击「开始监控」
4. 会弹出一个新窗口显示直播间
5. **查看主进程控制台**（运行 npm run dev 的终端窗口）

#### 方法 2: 使用 LiveRoomDycast.vue (直接 WebSocket 连接)

1. 进入「弹幕监控 (dycast)」页面
2. 输入直播间地址或房间号
3. 点击「开始监控」
4. 在页面上实时显示弹幕
5. **查看渲染进程控制台**（按 F12 打开开发者工具）

## 📊 控制台输出示例

### WebSocket 连接建立

```
🔗 WebSocket 已连接: wss://webcast5-ws-web-hl.douyin.com/...
```

### WebSocket 消息统计（每 10 条输出一次）

```
📊 WebSocket 统计: 已接收 1 条二进制消息
📊 WebSocket 统计: 已接收 11 条二进制消息
📊 WebSocket 统计: 已接收 21 条二进制消息
```

### Protobuf 解析输出

```
📦 [Protobuf] 收到消息: payloadType=msg, logId=2024112712345678...
   🗜️  检测到 gzip 压缩，解压中...
   ✅ 解压成功: 2456 bytes
   📋 消息数量: 5
   ├─ 消息 1/5: WebcastChatMessage
   │  ✓ [可爱的小猫咪] 主播好厉害啊
   ├─ 消息 2/5: WebcastGiftMessage
   │  ✓ [土豪用户] 玫瑰
   ├─ 消息 3/5: WebcastMemberMessage
   │  ✓ [路人甲] 进入直播间
   ├─ 消息 4/5: WebcastLikeMessage
   │  ✓ [点赞王] 点赞 x999
   ├─ 消息 5/5: WebcastSocialMessage
   │  ✓ [新粉丝] 关注了主播
   ✅ 解析完成：5 条有效弹幕
```

### 详细弹幕输出

#### 聊天消息
```
💬 [14:35:21] 聊天消息
   👤 可爱的小猫咪 (Lv.18)
   内容: 主播好厉害啊
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 礼物消息
```
🎁 [14:35:22] 礼物消息
   👤 土豪用户 (Lv.65)
   礼物: 玫瑰 x1
   价值: 1 抖币
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 进入直播间
```
✨ [14:35:23] 进入直播间
   👤 路人甲 (Lv.5)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 点赞
```
👍 [14:35:24] 点赞
   👤 点赞王 (Lv.32)
   点赞 x999
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 关注主播
```
✨ [14:35:25] 关注主播
   👤 新粉丝 (Lv.12)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 🎯 测试场景

### 场景 1: 热门直播间（高流量）

**推荐房间：** 粉丝量 > 100万的主播直播间

**预期效果：**
- 每秒收到多条弹幕
- 控制台快速滚动
- WebSocket 统计数字快速增长

**观察指标：**
```
📊 WebSocket 统计: 已接收 101 条二进制消息  (10秒内)
```

### 场景 2: 小型直播间（低流量）

**推荐房间：** 粉丝量 < 10万的主播直播间

**预期效果：**
- 偶尔收到弹幕
- 大部分是心跳包
- 便于观察单条弹幕的完整解析过程

**观察指标：**
```
📦 [Protobuf] 收到消息: payloadType=hb, logId=...  (心跳包，每几秒一次)
📦 [Protobuf] 收到消息: payloadType=msg, logId=... (弹幕，偶尔出现)
```

### 场景 3: 礼物测试

**测试方法：**
1. 找一个正在送礼的直播间
2. 观察礼物消息的解析

**预期输出：**
```
🎁 [14:35:22] 礼物消息
   👤 送礼者昵称 (Lv.XX)
   礼物: 礼物名称 xN
   价值: XX 抖币
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 场景 4: 表情消息测试

**测试方法：**
1. 自己在直播间发送表情
2. 观察表情消息的解析

**预期输出：**
```
💬 [14:35:26] 聊天消息
   👤 你的昵称 (Lv.XX)
   内容: [表情]
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 🔍 故障排查

### 问题 1: 控制台没有任何输出

**可能原因：**
- WebSocket 连接失败
- 直播间地址错误
- 未登录或 Cookie 过期

**解决方法：**
1. 检查是否看到 `🔗 WebSocket 已连接` 日志
2. 检查直播间地址是否正确
3. 重新登录抖音账号

### 问题 2: 只有心跳包，没有弹幕

**可能原因：**
- 直播间暂时没人发弹幕
- 直播间人气太低

**解决方法：**
1. 等待一段时间
2. 换一个更热门的直播间
3. 自己在直播间发送弹幕测试

### 问题 3: 解析失败

**错误示例：**
```
❌ Protobuf 解析失败: Invalid wire type
```

**可能原因：**
- 抖音更新了 Protobuf 协议
- gzip 解压失败
- 数据损坏

**解决方法：**
1. 查看是否有新版本的 dycast-model.ts
2. 尝试重启应用
3. 提交 issue 报告问题

### 问题 4: 弹幕窗口是空白的

**可能原因：**
- URL 解析失败
- 直播间不存在
- 网络问题

**解决方法：**
1. 查看控制台的 URL 解析日志：
   ```
   📍 加载地址: https://...
   ```
2. 在浏览器中手动访问该地址，确认直播间存在
3. 查看是否有 `did-fail-load` 错误日志

## 📝 验证清单

测试完成后，确认以下功能正常：

- [ ] WebSocket 连接成功
- [ ] 能看到聊天消息
- [ ] 能看到礼物消息
- [ ] 能看到进入直播间消息
- [ ] 能看到点赞消息
- [ ] 能看到关注消息
- [ ] 消息格式正确（昵称、内容、时间戳等）
- [ ] 控制台输出清晰易读
- [ ] 没有报错或异常

## 🎓 下一步

功能验证通过后，你可以：

1. **调整日志级别** - 减少不必要的输出
2. **实现数据存储** - 将弹幕保存到数据库
3. **实现过滤功能** - 过滤特定用户或关键词
4. **实现统计功能** - 统计弹幕数量、热词等
5. **实现打印功能** - 将弹幕发送到打印机

## 🆘 需要帮助？

如果遇到问题：

1. 查看 `docs/弹幕消息Hook和解析说明.md`
2. 查看控制台的完整错误日志
3. 检查 `electron/douyin/` 目录下的相关代码
4. 提交 GitHub Issue 并附上日志信息


