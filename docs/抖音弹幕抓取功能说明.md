# æŠ–éŸ³ç›´æ’­é—´å¼¹å¹•æŠ“å–åŠŸèƒ½è¯´æ˜

## âœ¨ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†é€šè¿‡ç›´æ’­é—´é“¾æ¥å®æ—¶æŠ“å–å¼¹å¹•çš„å®Œæ•´åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§å¼¹å¹•ç±»å‹ï¼ˆæ–‡æœ¬ã€ç¤¼ç‰©ã€å…³æ³¨ç­‰ï¼‰ã€‚

---

## ğŸ¯ æŠ€æœ¯æ–¹æ¡ˆ

### WebSocket Hook + BrowserView

1. **æ‰“å¼€ç›´æ’­é—´é¡µé¢**
   - ä½¿ç”¨ Electron BrowserView åŠ è½½æŠ–éŸ³ç›´æ’­é—´
   - æ³¨å…¥å·²ä¿å­˜çš„ Cookieï¼ˆä¿æŒç™»å½•çŠ¶æ€ï¼‰

2. **æ‹¦æˆª WebSocket**
   - åœ¨é¡µé¢åŠ è½½å‰æ³¨å…¥ Hook è„šæœ¬
   - ä»£ç† WebSocket æ„é€ å‡½æ•°
   - ç›‘å¬ onmessage äº‹ä»¶

3. **è§£æå¼¹å¹•æ•°æ®**
   - æ”¯æŒ JSON æ ¼å¼æ•°æ®
   - æ”¯æŒ Protobuf äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¾…å®ç°å®Œæ•´è§£æï¼‰
   - æå–ç”¨æˆ·ä¿¡æ¯ã€å¼¹å¹•å†…å®¹ã€ç¤¼ç‰©ä¿¡æ¯ç­‰

4. **æ•°æ®å¤„ç†**
   - é€šè¿‡ IPC å‘é€åˆ°ä¸»è¿›ç¨‹
   - å­˜å‚¨åˆ° SQLite æ•°æ®åº“
   - è½¬å‘åˆ°æ¸²æŸ“è¿›ç¨‹å®æ—¶æ˜¾ç¤º

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
electron/douyin/
â”œâ”€â”€ live-monitor.ts      # ç›´æ’­é—´ç›‘æ§ç®¡ç†å™¨
â”œâ”€â”€ cookie-manager.ts    # Cookie ç®¡ç†ï¼ˆå·²æœ‰ï¼‰
â””â”€â”€ login-window.ts      # ç™»å½•çª—å£ï¼ˆå·²æœ‰ï¼‰

electron/ipc/
â””â”€â”€ handlers.ts          # IPC æ¥å£ï¼ˆæ–°å¢ç›‘æ§ç›¸å…³ï¼‰

src/views/
â””â”€â”€ LiveRoom.vue         # ç›´æ’­ç›‘æ§é¡µé¢

src/stores/
â””â”€â”€ barrage.ts           # å¼¹å¹•çŠ¶æ€ç®¡ç†
```

---

## ğŸ”Œ æ ¸å¿ƒå®ç°

### 1. LiveMonitor ç±» (`electron/douyin/live-monitor.ts`)

```typescript
class LiveMonitor {
  // å¼€å§‹ç›‘æ§ç›´æ’­é—´
  async start(
    parentWindow: BrowserWindow,
    roomUrl: string,
    onBarrage?: (barrage: BarrageData) => void
  ): Promise<{ success: boolean; message?: string }>

  // åœæ­¢ç›‘æ§
  stop(): void

  // æ£€æŸ¥ç›‘æ§çŠ¶æ€
  isActive(): boolean

  // è·å–å½“å‰æˆ¿é—´ID
  getRoomId(): string
}
```

#### å…³é”®åŠŸèƒ½

**a. åˆ›å»ºç›‘æ§çª—å£**
```typescript
private async createWindow(parentWindow: BrowserWindow): Promise<void> {
  // åˆ›å»ºç‹¬ç«‹çª—å£
  this.window = new BrowserWindow({
    parent: parentWindow,
    width: 1200,
    height: 800,
    webPreferences: {
      partition: 'persist:douyin',  // ç‹¬ç«‹Session
      contextIsolation: false,       // å…è®¸æ³¨å…¥è„šæœ¬
    },
  })

  // åˆ›å»º BrowserView
  this.browserView = new BrowserView(...)
}
```

**b. æ³¨å…¥ WebSocket Hook**
```typescript
private async injectWebSocketHook(): Promise<void> {
  const hookScript = `
    // ä¿å­˜åŸå§‹ WebSocket
    const OriginalWebSocket = window.WebSocket;
    
    // åˆ›å»ºä»£ç†
    window.WebSocket = function(url, protocols) {
      const ws = new OriginalWebSocket(url, protocols);
      
      // æ‹¦æˆª onmessage
      ws.onmessage = function(event) {
        // è§£ææ•°æ®
        parseBarrageData(event.data);
        
        // å‘é€åˆ°ä¸»è¿›ç¨‹
        window.electron.sendBarrage(barrage);
      };
      
      return ws;
    };
  `
  
  await this.browserView.webContents.executeJavaScript(hookScript)
}
```

**c. è§£æå¼¹å¹•æ•°æ®**
```typescript
function parseBarrageData(json) {
  if (json.type === 'chat') {
    // æ™®é€šæ–‡æœ¬å¼¹å¹•
    return {
      userId: json.user?.id,
      nickname: json.user?.nickname,
      content: json.content,
      type: 'text',
    };
  } else if (json.type === 'gift') {
    // ç¤¼ç‰©å¼¹å¹•
    return {
      userId: json.user?.id,
      nickname: json.user?.nickname,
      content: 'é€å‡ºäº†ç¤¼ç‰©',
      type: 'gift',
      giftName: json.gift?.name,
      giftCount: json.gift?.count,
      giftValue: json.gift?.value,
    };
  }
}
```

### 2. IPC é€šä¿¡æ¥å£ (`electron/ipc/handlers.ts`)

```typescript
// å¼€å§‹ç›‘æ§
ipcMain.handle('douyin:startLiveMonitoring', async (event, roomUrl) => {
  const result = await liveMonitor.start(mainWindow, roomUrl, (barrage) => {
    // å­˜å‚¨åˆ°æ•°æ®åº“
    const barrageId = sqliteManager.insertBarrage(barrage)
    
    // å‘é€åˆ°æ¸²æŸ“è¿›ç¨‹
    event.sender.send('barrage:received', barrage)
  })
  
  return result
})

// åœæ­¢ç›‘æ§
ipcMain.handle('douyin:stopLiveMonitoring', async () => {
  liveMonitor.stop()
  return { success: true }
})

// è·å–ç›‘æ§çŠ¶æ€
ipcMain.handle('douyin:getMonitoringStatus', async () => {
  return {
    isActive: liveMonitor.isActive(),
    roomId: liveMonitor.getRoomId(),
  }
})
```

### 3. å‰ç«¯é¡µé¢ (`src/views/LiveRoom.vue`)

#### UI ç»„ä»¶

```vue
<template>
  <div class="live-room">
    <!-- æ§åˆ¶é¢æ¿ -->
    <el-card>
      <!-- ç™»å½•æç¤º -->
      <el-alert v-if="!isLoggedIn">
        è¯·å…ˆç™»å½•æŠ–éŸ³è´¦å·
      </el-alert>

      <!-- è¾“å…¥æ¡† -->
      <el-input
        v-model="roomUrl"
        placeholder="è¾“å…¥ç›´æ’­é—´é“¾æ¥æˆ–æˆ¿é—´å·"
      />

      <!-- æ“ä½œæŒ‰é’® -->
      <el-button @click="handleStart">
        å¼€å§‹ç›‘æ§
      </el-button>
      <el-button @click="handleStop">
        åœæ­¢ç›‘æ§
      </el-button>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <el-statistic title="å·²æ”¶å¼¹å¹•" :value="barrageCount" />
    </el-card>

    <!-- å¼¹å¹•åˆ—è¡¨ -->
    <el-card>
      <div v-for="barrage in barrages">
        <el-avatar :src="barrage.avatarUrl" />
        <span>{{ barrage.nickname }}: {{ barrage.content }}</span>
      </div>
    </el-card>
  </div>
</template>
```

#### æ ¸å¿ƒé€»è¾‘

```typescript
// å¼€å§‹ç›‘æ§
const handleStart = async () => {
  const result = await window.electronAPI.startLiveMonitoring(roomUrl.value)
  
  if (result.success) {
    isMonitoring.value = true
    ElMessage.success('ç›‘æ§å·²å¯åŠ¨')
  }
}

// åœæ­¢ç›‘æ§
const handleStop = async () => {
  await window.electronAPI.stopLiveMonitoring()
  isMonitoring.value = false
}
```

---

## ğŸ¨ å¼¹å¹•æ•°æ®ç»“æ„

### BarrageData æ¥å£

```typescript
interface BarrageData {
  userId: string           // ç”¨æˆ·ID
  nickname: string         // æ˜µç§°
  userLevel?: number       // ç”¨æˆ·ç­‰çº§
  avatarUrl?: string       // å¤´åƒURL
  content: string          // å¼¹å¹•å†…å®¹
  type: 'text' | 'gift' | 'like' | 'follow' | 'share'  // ç±»å‹
  giftId?: string          // ç¤¼ç‰©ID
  giftName?: string        // ç¤¼ç‰©åç§°
  giftCount?: number       // ç¤¼ç‰©æ•°é‡
  giftValue?: number       // ç¤¼ç‰©ä»·å€¼ï¼ˆæŠ–å¸ï¼‰
  timestamp: number        // æ—¶é—´æˆ³
  metadata?: any           // å…¶ä»–å…ƒæ•°æ®
}
```

### å¼¹å¹•ç±»å‹

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `text` | æ™®é€šæ–‡æœ¬å¼¹å¹• | "666ï¼ä¸»æ’­å¤ªå‰å®³äº†" |
| `gift` | ç¤¼ç‰©å¼¹å¹• | "é€å‡ºäº†å˜‰å¹´å x3" |
| `like` | ç‚¹èµ | "ç‚¹äº†ä¸ªèµ" |
| `follow` | å…³æ³¨/è¿›å…¥ç›´æ’­é—´ | "è¿›å…¥ç›´æ’­é—´" |
| `share` | åˆ†äº« | "åˆ†äº«äº†ç›´æ’­é—´" |

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. ç™»å½•æŠ–éŸ³è´¦å·

```
è®¾ç½® â†’ æŠ–éŸ³è´¦å· â†’ ç™»å½•æŠ–éŸ³è´¦å·
```

### 2. è¿›å…¥ç›´æ’­ç›‘æ§é¡µé¢

```
ä¾§è¾¹æ  â†’ ç›´æ’­ç›‘æ§
```

### 3. è¾“å…¥ç›´æ’­é—´é“¾æ¥

æ”¯æŒçš„æ ¼å¼ï¼š
- **å®Œæ•´é“¾æ¥**: `https://live.douyin.com/123456789`
- **æˆ¿é—´å·**: `123456789`

### 4. ç‚¹å‡»"å¼€å§‹ç›‘æ§"

- ä¼šæ‰“å¼€ä¸€ä¸ªæ–°çª—å£ï¼ŒåŠ è½½ç›´æ’­é—´
- è‡ªåŠ¨æ³¨å…¥ Cookieï¼ˆä¿æŒç™»å½•ï¼‰
- è‡ªåŠ¨æ‹¦æˆª WebSocket
- å¼€å§‹æ¥æ”¶å¼¹å¹•

### 5. å®æ—¶æŸ¥çœ‹å¼¹å¹•

- ä¸»ç•Œé¢å®æ—¶æ˜¾ç¤ºå¼¹å¹•æµ
- ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¼¹å¹•æ•°ã€ç¤¼ç‰©æ•°ã€è¿è¡Œæ—¶é•¿ï¼‰
- å¼¹å¹•è‡ªåŠ¨å­˜å‚¨åˆ°æ•°æ®åº“

### 6. åœæ­¢ç›‘æ§

ç‚¹å‡»"åœæ­¢ç›‘æ§"æŒ‰é’®ï¼Œå…³é—­ç›‘æ§çª—å£ã€‚

---

## ğŸ“Š æ•°æ®æµå‘

```
ç›´æ’­é—´é¡µé¢ (WebSocket)
    â†“
WebSocket Hook (æ‹¦æˆª)
    â†“
è§£æå¼¹å¹•æ•°æ® (JSON/Protobuf)
    â†“
IPC é€šä¿¡ â†’ ä¸»è¿›ç¨‹
    â†“
    â”œâ”€â†’ å­˜å‚¨åˆ° SQLite æ•°æ®åº“
    â””â”€â†’ è½¬å‘åˆ°æ¸²æŸ“è¿›ç¨‹
           â†“
      å®æ—¶æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### Session éš”ç¦»

```typescript
partition: 'persist:douyin'
```

- ä¸ç™»å½•çª—å£ä½¿ç”¨ç›¸åŒçš„ Session
- Cookie è‡ªåŠ¨å…±äº«
- ä¿æŒç™»å½•çŠ¶æ€

### å®‰å…¨è®¾ç½®

```typescript
webPreferences: {
  contextIsolation: false,  // å…è®¸æ³¨å…¥è„šæœ¬
  nodeIntegration: false,    // ç¦æ­¢ Node.js é›†æˆ
  webSecurity: false,        // å¼€å‘ç¯å¢ƒå…è®¸è·¨åŸŸ
}
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ WebSocket è¿æ¥

åœ¨ç›‘æ§çª—å£çš„æ§åˆ¶å°ï¼ˆF12ï¼‰ä¸­ï¼š

```javascript
console.log('ğŸ”Œ WebSocket è¿æ¥:', url)
```

### 2. æŸ¥çœ‹å¼¹å¹•æ•°æ®

```javascript
console.log('ğŸ“ æ”¶åˆ°æ–‡æœ¬å¼¹å¹•æ•°æ®:', json)
console.log('ğŸ“¦ æ”¶åˆ°äºŒè¿›åˆ¶å¼¹å¹•æ•°æ®:', data)
```

### 3. ä¸»è¿›ç¨‹æ—¥å¿—

Terminal çª—å£ä¼šæ˜¾ç¤ºï¼š

```
ğŸ¥ å¼€å§‹ç›‘æ§ç›´æ’­é—´: 123456789
âœ… Cookie å·²æ³¨å…¥åˆ°ç›´æ’­é—´Session
âœ… WebSocket Hook è„šæœ¬å·²æ³¨å…¥
âœ… ç›´æ’­é—´é¡µé¢åŠ è½½å®Œæˆ
ğŸ“¨ æ”¶åˆ°å¼¹å¹•: æµ‹è¯•ç”¨æˆ·: 666ï¼
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç‚¹å‡»"å¼€å§‹ç›‘æ§"æ²¡æœ‰ååº”ï¼Ÿ

**æ£€æŸ¥**:
1. æ˜¯å¦å·²ç™»å½•æŠ–éŸ³è´¦å·
2. ç›´æ’­é—´é“¾æ¥æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹ Terminal æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

### Q2: ç›‘æ§çª—å£æ‰“å¼€ä½†æ²¡æœ‰å¼¹å¹•ï¼Ÿ

**åŸå› **:
1. ç›´æ’­é—´å¯èƒ½æ²¡æœ‰äººå‘å¼¹å¹•
2. WebSocket Hook å¯èƒ½æœªæ­£ç¡®æ³¨å…¥
3. æŠ–éŸ³çš„å¼¹å¹•æ•°æ®æ ¼å¼å¯èƒ½å·²å˜åŒ–

**è§£å†³**:
1. åœ¨ç›‘æ§çª—å£æŒ‰ F12 æ‰“å¼€æ§åˆ¶å°
2. æŸ¥çœ‹æ˜¯å¦æœ‰ "WebSocket Hook å·²æ³¨å…¥" æ—¥å¿—
3. æŸ¥çœ‹æ˜¯å¦æœ‰ WebSocket è¿æ¥æ—¥å¿—

### Q3: å¼¹å¹•æ•°æ®è§£æå¤±è´¥ï¼Ÿ

**åŸå› **: æŠ–éŸ³å¼¹å¹•æ•°æ®æ ¼å¼å¯èƒ½æ›´æ–°

**è§£å†³**: éœ€è¦æ›´æ–° `parseBarrageData` å‡½æ•°ä¸­çš„è§£æé€»è¾‘

### Q4: æ˜¾ç¤º"è¯·å…ˆç™»å½•æŠ–éŸ³è´¦å·"ï¼Ÿ

**è§£å†³**:
1. è¿›å…¥"è®¾ç½®" â†’ "æŠ–éŸ³è´¦å·"
2. ç‚¹å‡»"ç™»å½•æŠ–éŸ³è´¦å·"
3. å®Œæˆç™»å½•åé‡è¯•

---

## ğŸ”® æœªæ¥ä¼˜åŒ–

### 1. Protobuf å®Œæ•´æ”¯æŒ

ç›®å‰å¯¹äºŒè¿›åˆ¶æ•°æ®çš„æ”¯æŒæœ‰é™ï¼Œéœ€è¦ï¼š
- è·å–æŠ–éŸ³ Protobuf åè®®å®šä¹‰
- å®ç°å®Œæ•´çš„ Protobuf è§£æ
- æ”¯æŒæ›´å¤šå¼¹å¹•ç±»å‹

### 2. å¼¹å¹•è¿‡æ»¤

- æŒ‰ç”¨æˆ·ç­‰çº§è¿‡æ»¤
- æŒ‰ç¤¼ç‰©ä»·å€¼è¿‡æ»¤
- å…³é”®è¯è¿‡æ»¤
- è‡ªå®šä¹‰è§„åˆ™

### 3. è‡ªåŠ¨æ‰“å°

- æ”¶åˆ°å¼¹å¹•åè‡ªåŠ¨æ‰“å°
- æ”¯æŒæ‰“å°é˜Ÿåˆ—
- æ”¯æŒæ‰“å°æ¨¡æ¿

### 4. å¤šç›´æ’­é—´ç›‘æ§

- åŒæ—¶ç›‘æ§å¤šä¸ªç›´æ’­é—´
- åˆ†å±æ˜¾ç¤º
- ç‹¬ç«‹ç»Ÿè®¡

### 5. æ•°æ®ç»Ÿè®¡

- å¼¹å¹•è¯äº‘
- çƒ­é—¨ç”¨æˆ·æ’è¡Œ
- ç¤¼ç‰©ç»Ÿè®¡å›¾è¡¨
- å®æ—¶æ•°æ®åˆ†æ

---

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

### 1. WebSocket Hook æ—¶æœº

Hook å¿…é¡»åœ¨é¡µé¢åŠ è½½å‰æ³¨å…¥ï¼š

```typescript
this.browserView.webContents.on('did-start-loading', async () => {
  await this.injectWebSocketHook()
})
```

### 2. æ•°æ®æ ¼å¼å…¼å®¹æ€§

æŠ–éŸ³çš„å¼¹å¹•æ•°æ®æ ¼å¼å¯èƒ½ä¼šæ›´æ–°ï¼Œéœ€è¦ï¼š
- ä¿æŒå¯¹æ—¥å¿—çš„ç›‘æ§
- åŠæ—¶æ›´æ–°è§£æé€»è¾‘
- æä¾›é™çº§æ–¹æ¡ˆ

### 3. å†…å­˜ç®¡ç†

å¼¹å¹•æ•°æ®å¯èƒ½å¾ˆå¤šï¼Œéœ€è¦ï¼š
- é™åˆ¶å†…å­˜ä¸­çš„å¼¹å¹•æ•°é‡
- å®šæœŸæ¸…ç†æ—§æ•°æ®
- ä½¿ç”¨åˆ†é¡µåŠ è½½

### 4. é”™è¯¯å¤„ç†

- WebSocket è¿æ¥å¤±è´¥
- æ•°æ®è§£æé”™è¯¯
- æ•°æ®åº“å­˜å‚¨å¤±è´¥

éƒ½éœ€è¦æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤ºã€‚

---

## ğŸ‰ æ€»ç»“

### å·²å®ç°åŠŸèƒ½

âœ… é€šè¿‡ç›´æ’­é—´é“¾æ¥æ‰“å¼€ç›‘æ§çª—å£  
âœ… è‡ªåŠ¨æ³¨å…¥ Cookie ä¿æŒç™»å½•  
âœ… WebSocket Hook æ‹¦æˆªå¼¹å¹•æ•°æ®  
âœ… è§£æ JSON æ ¼å¼å¼¹å¹•æ•°æ®  
âœ… å®æ—¶æ˜¾ç¤ºå¼¹å¹•æµ  
âœ… å­˜å‚¨åˆ° SQLite æ•°æ®åº“  
âœ… ç»Ÿè®¡ä¿¡æ¯å±•ç¤º  
âœ… å¼€å§‹/åœæ­¢ç›‘æ§  

### å¾…å®ç°åŠŸèƒ½

â³ Protobuf å®Œæ•´è§£æ  
â³ å¼¹å¹•è¿‡æ»¤è§„åˆ™  
â³ è‡ªåŠ¨æ‰“å°åŠŸèƒ½  
â³ å¤šç›´æ’­é—´ç›‘æ§  
â³ æ•°æ®ç»Ÿè®¡åˆ†æ  

---

**Â© 2025 - æŠ–éŸ³å¼¹å¹•æŠ“å–ç³»ç»Ÿ | å®æ—¶ç›‘æ§ç›´æ’­é—´ ğŸ¥**

