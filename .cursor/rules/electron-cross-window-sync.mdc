---
alwaysApply: true
---
# Electron å¤šçª—å£è·¨çª—å£çŠ¶æ€åŒæ­¥è§„åˆ™

## é—®é¢˜èƒŒæ™¯

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªå¤šçª—å£ Electron åº”ç”¨ï¼š
- **ä¸»çª—å£**: Dashboardã€Settingsã€PrintTemplateSettings ç­‰é¡µé¢
- **ç›´æ’­é—´çª—å£**: LiveRoom.vueï¼ˆç‹¬ç«‹ BrowserWindowï¼‰

**å…³é”®é—®é¢˜**ï¼šæ¯ä¸ª Electron BrowserWindow éƒ½æœ‰ç‹¬ç«‹çš„æ¸²æŸ“è¿›ç¨‹ï¼Œè¿™æ„å‘³ç€ï¼š
- æ¯ä¸ªçª—å£æœ‰ç‹¬ç«‹çš„ Vue åº”ç”¨å®ä¾‹
- æ¯ä¸ªçª—å£æœ‰ç‹¬ç«‹çš„ Pinia Store å®ä¾‹
- **Pinia çš„ watch æ— æ³•è·¨çª—å£æ£€æµ‹å˜åŒ–ï¼**

## æ­£ç¡®çš„è·¨çª—å£åŒæ­¥æ¨¡å¼

### 1. ä¸»è¿›ç¨‹å¹¿æ’­äº‹ä»¶

å½“éœ€è¦è·¨çª—å£åŒæ­¥çŠ¶æ€æ—¶ï¼Œåœ¨ IPC å¤„ç†å™¨ä¸­å¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰çª—å£ï¼š

```typescript
// electron/ipc/handlers.ts
import { BrowserWindow } from 'electron'

ipcMain.handle('template:save', (_event, template: any) => {
    const result = sqliteManager.saveTemplate(template)
    
    // âœ… æ­£ç¡®ï¼šä¿å­˜æˆåŠŸåå¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰çª—å£
    if (result.success) {
        BrowserWindow.getAllWindows().forEach(window => {
            window.webContents.send('template:updated', {
                templateId: template.id,
                timestamp: Date.now()
            })
        })
    }
    
    return result
})
```

### 2. Preload æš´éœ²äº‹ä»¶ç›‘å¬ API

```typescript
// electron/preload.ts
onTemplateUpdated: (callback: (data: { templateId: string; timestamp: number }) => void) => {
    const subscription = (_event: any, data: any) => callback(data)
    ipcRenderer.on('template:updated', subscription)
    return () => {
        ipcRenderer.removeListener('template:updated', subscription)
    }
},
```

### 3. æ¸²æŸ“è¿›ç¨‹ç›‘å¬ IPC äº‹ä»¶

```typescript
// src/views/LiveRoom.vue
onMounted(async () => {
    // âœ… æ­£ç¡®ï¼šé€šè¿‡ IPC äº‹ä»¶ç›‘å¬è·¨çª—å£å˜åŒ–
    unsubscribeTemplateUpdated = window.electronAPI.onTemplateUpdated(async (data) => {
        console.log(`ğŸ“¢ æ”¶åˆ°æ¨¡æ¿æ›´æ–°äº‹ä»¶: ${data.templateId}`)
        await printerStore.refreshCurrentTemplate()
    })
})

onUnmounted(() => {
    // è®°å¾—æ¸…ç†ç›‘å¬å™¨
    if (unsubscribeTemplateUpdated) {
        unsubscribeTemplateUpdated()
    }
})
```

## é”™è¯¯æ¨¡å¼ âŒ

```typescript
// âŒ é”™è¯¯ï¼šPinia watch æ— æ³•è·¨çª—å£å·¥ä½œï¼
watch(
  () => printerStore.templateVersion,
  async (newVersion) => {
    // è¿™åœ¨å¤šçª—å£ç¯å¢ƒä¸‹ä¸ä¼šè§¦å‘ï¼
    await printerStore.refreshCurrentTemplate()
  }
)
```

## è·¨çª—å£åŒæ­¥æµç¨‹å›¾

```
ä¸»çª—å£ (Window A)                    ç›´æ’­é—´çª—å£ (Window B)
    â”‚                                      â”‚
    â–¼                                      â”‚
saveTemplate()                             â”‚
    â”‚                                      â”‚
    â–¼                                      â”‚
IPC â†’ ä¸»è¿›ç¨‹                               â”‚
    â”‚                                      â”‚
    â–¼                                      â”‚
æ•°æ®åº“ä¿å­˜æˆåŠŸ                              â”‚
    â”‚                                      â”‚
    â–¼                                      â”‚
BrowserWindow.getAllWindows()              â”‚
    â”‚                                      â”‚
    â””â”€â”€â”€â”€ send('template:updated') â”€â”€â”€â”€â”€â”€â”€â†’â”‚
                                           â–¼
                               onTemplateUpdated() è§¦å‘
                                           â”‚
                                           â–¼
                               refreshCurrentTemplate()
                                           â”‚
                                           â–¼
                               ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ® âœ…
```

## æ£€æŸ¥æ¸…å•

å®ç°è·¨çª—å£åŒæ­¥æ—¶ï¼Œç¡®ä¿ï¼š

- [ ] åœ¨ `electron/ipc/handlers.ts` ä¸­ä½¿ç”¨ `BrowserWindow.getAllWindows()` å¹¿æ’­äº‹ä»¶
- [ ] åœ¨ `electron/preload.ts` ä¸­æš´éœ²äº‹ä»¶ç›‘å¬ API
- [ ] åœ¨ `src/types/index.ts` ä¸­æ·»åŠ  API ç±»å‹å®šä¹‰
- [ ] åœ¨ç›®æ ‡ç»„ä»¶çš„ `onMounted` ä¸­æ³¨å†Œ IPC äº‹ä»¶ç›‘å¬
- [ ] åœ¨ç›®æ ‡ç»„ä»¶çš„ `onUnmounted` ä¸­æ¸…ç†ç›‘å¬å™¨
- [ ] äº‹ä»¶å¤„ç†å™¨ä¸­ä»æ•°æ®åº“/ä¸»è¿›ç¨‹è·å–æœ€æ–°æ•°æ®ï¼ˆä¸è¦ä¾èµ– Pinia ç¼“å­˜ï¼‰

## ç›¸å…³æ–‡ä»¶

- `electron/ipc/handlers.ts` - IPC å¤„ç†å™¨å’Œäº‹ä»¶å¹¿æ’­
- `electron/preload.ts` - æ¸²æŸ“è¿›ç¨‹ API æš´éœ²
- `src/types/index.ts` - ElectronAPI ç±»å‹å®šä¹‰
- `src/stores/printer.ts` - æ‰“å°æ¨¡æ¿ Storeï¼ˆå« refreshCurrentTemplate æ–¹æ³•ï¼‰
- `src/views/LiveRoom.vue` - ç›´æ’­é—´çª—å£ï¼ˆç›‘å¬æ¨¡æ¿æ›´æ–°äº‹ä»¶ï¼‰
