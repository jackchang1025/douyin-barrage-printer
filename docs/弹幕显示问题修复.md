# 弹幕显示问题修复说明

## 🐛 问题描述

### 问题 1：页面显示测试数据
- **现象**：直播间监控页面启动时就显示了测试弹幕
- **原因**：Dashboard.vue 在开发模式下会自动调用 `initMockData()` 加载模拟数据

### 问题 2：控制台能监控到弹幕，但页面不显示
- **现象**：Electron 控制台能看到 Protobuf 解析成功的弹幕，但 LiveRoom.vue 页面没有显示
- **原因**：LiveRoom.vue 没有监听 IPC 的 `barrage:received` 事件

## ✅ 修复方案

### 1. 移除测试数据

#### 修改文件：`src/views/Dashboard.vue`
```typescript
// 修改前
if (import.meta.env.DEV) {
  console.log('🚀 开发模式：加载模拟弹幕数据')
  await barrageStore.initMockData()  // ❌ 会加载测试数据
  await printerStore.loadSettings()
}

// 修改后
if (import.meta.env.DEV) {
  console.log('🚀 开发模式：跳过加载模拟数据')
  // 移除测试数据，实际弹幕将从直播间监控中获取
  await printerStore.loadSettings()
}
```

#### 修改文件：`src/stores/barrage.ts`
- ✅ 删除 `initMockData()` 函数
- ✅ 从 return 语句中移除 `initMockData`

### 2. 修复弹幕监听

#### 问题分析

**IPC 通信流程**：
```
直播间页面 (BrowserView)
    ↓ WebSocket Hook
    ↓ console.log(__BARRAGE_BINARY__:...)
live-monitor.ts
    ↓ console-message 事件
    ↓ Protobuf 解析
    ↓ 调用 onBarrage 回调
IPC handlers (douyin:startLiveMonitoring)
    ↓ event.sender.send('barrage:received', barrage)
??? (没有监听)
    ↓
LiveRoom.vue (没有显示) ❌
```

**根本原因**：LiveRoom.vue 调用了 `window.electronAPI.startLiveMonitoring()`，但没有监听 `barrage:received` 事件！

#### 修改文件：`src/views/LiveRoom.vue`

**修复后的流程**：
```typescript
const handleStart = async () => {
  // 1. 清空之前的数据
  barrageStore.clearBarrages()

  // 2. 📡 设置弹幕监听（关键！）
  const unsubscribe = window.electronAPI.onBarrageReceived((barrage) => {
    console.log('📨 LiveRoom 收到弹幕:', barrage)
    
    // 添加到 barrageStore
    barrageStore.barrages.unshift({
      id: Date.now() + Math.random(),
      user_id: barrage.userId || barrage.user_id,
      nickname: barrage.nickname,
      content: barrage.content,
      type: barrage.type || 'chat',
      // ... 其他字段
    })

    // 限制列表长度（最多 500 条）
    if (barrageStore.barrages.length > 500) {
      barrageStore.barrages.pop()
    }
  })

  // 保存 unsubscribe 函数
  (window as any).__barrageUnsubscribe = unsubscribe

  // 3. 启动监控
  const result = await window.electronAPI.startLiveMonitoring(roomUrl.value)
  // ...
}

const handleStop = async () => {
  // 停止监控
  await window.electronAPI.stopLiveMonitoring()
  
  // 📡 取消弹幕监听（关键！）
  if ((window as any).__barrageUnsubscribe) {
    (window as any).__barrageUnsubscribe()
    (window as any).__barrageUnsubscribe = null
  }
  // ...
}
```

## 📊 完整数据流

修复后的完整流程：

```
1. 用户点击"开始监控"
   ↓
2. LiveRoom.vue: 设置弹幕监听
   window.electronAPI.onBarrageReceived(callback)
   ↓
3. LiveRoom.vue: 调用启动监控
   window.electronAPI.startLiveMonitoring(roomUrl)
   ↓
4. IPC Handler: 创建 BrowserView
   ↓
5. live-monitor.ts: 注入 WebSocket Hook
   ↓
6. 抖音页面: 建立 WebSocket 连接
   ↓
7. WebSocket Hook: 拦截 message 事件
   ↓
8. 接收到二进制数据
   console.log('__BARRAGE_BINARY__:' + base64Data)
   ↓
9. live-monitor.ts: 捕获 console-message
   ↓
10. protobuf-parser.ts: 解析二进制数据
    - 解析 PushFrame
    - 检查 gzip 压缩并解压
    - 解析 Response
    - 解析 Message 列表
    - 提取弹幕数据
   ↓
11. live-monitor.ts: 调用 onBarrage 回调
   ↓
12. IPC Handler: 发送到渲染进程
    event.sender.send('barrage:received', barrage)
   ↓
13. preload.ts: 触发 IPC 事件
    ipcRenderer.on('barrage:received', callback)
   ↓
14. LiveRoom.vue: 接收弹幕数据
    barrageStore.barrages.unshift(barrage)
   ↓
15. Vue 响应式更新
   ↓
16. 页面显示弹幕 ✅
```

## 🎯 测试步骤

### 1. 清空测试数据
```bash
# 重启开发环境
npm run electron:dev
```

- ✅ 启动后，Dashboard 不应该显示测试弹幕
- ✅ 直播间监控页面初始状态为空

### 2. 测试弹幕监控
1. 进入"设置" → "抖音账号" → 点击"登录抖音"
2. 扫码登录
3. 进入"直播间监控"页面
4. 输入一个正在直播的完整地址：
   ```
   https://live.douyin.com/123456789012
   ```
5. 点击"开始监控"
6. 直播间窗口打开
7. 等待有人发弹幕

**预期结果**：
- ✅ 控制台输出：`📨 LiveRoom 收到弹幕: {...}`
- ✅ 右侧弹幕面板实时显示弹幕
- ✅ 统计数据实时更新

### 3. 测试窗口管理
1. 点击"隐藏直播间窗口"
   - ✅ 窗口隐藏
   - ✅ 弹幕继续显示（后台运行）
2. 点击"显示直播间窗口"
   - ✅ 窗口重新显示
3. 关闭直播间窗口（点击 X）
   - ✅ 弹幕继续显示（后台运行）
4. 点击"停止监控"
   - ✅ 窗口关闭
   - ✅ 监听取消
   - ✅ 弹幕停止更新

## 🔍 调试日志

修复后，控制台会输出以下日志：

```
📡 开始设置弹幕监听...
✅ 监控启动成功，等待弹幕...

🔍 ===== 开始解析 Protobuf 消息 =====
   数据大小: 546 bytes
📦 步骤1: 解析 PushFrame（外层包装）...
   ✅ PushFrame 解析成功
🗜️  步骤2: 检测到 gzip 压缩，开始解压...
   ✅ gzip 解压成功，解压后大小: 1234 bytes
📦 步骤3: 解析 Response...
   ✅ Response 解析成功，包含 5 条消息
📨 步骤4: 解析具体消息...
   --- 消息 #1 ---
   method: WebcastChatMessage
   ✅ 解析成功: 用户昵称 - 弹幕内容
🎉 解析完成，共得到 1 条弹幕数据

📨 LiveRoom 收到弹幕: {
  type: 'chat',
  userId: '12345',
  nickname: '用户昵称',
  content: '弹幕内容',
  timestamp: 1732674000000
}
```

## 📌 注意事项

1. **确保已登录抖音**：监控前必须先登录
2. **使用完整 URL**：不支持单独的房间号
3. **窗口管理**：关闭窗口不会停止监控
4. **内存管理**：弹幕列表最多保留 500 条
5. **数据持久化**：弹幕会保存到 SQLite 数据库

## ✅ 修复总结

| 问题 | 原因 | 修复方案 | 状态 |
|------|------|---------|------|
| 测试数据显示 | Dashboard 自动加载 | 移除 initMockData 调用 | ✅ |
| 弹幕不显示 | 没有监听 IPC 事件 | 添加 onBarrageReceived 监听 | ✅ |
| 内存泄漏隐患 | 没有取消监听 | 停止时调用 unsubscribe | ✅ |

---

更新时间：2025-11-27
版本：v2.1

